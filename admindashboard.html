<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Dashboard - ECE Library</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --info: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-bottom: 50px;
            overflow-x: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 12px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .logo i {
            font-size: 1.8rem;
            color: var(--light);
        }

        .logo h1 {
            font-size: 1.2rem;
            font-weight: 700;
            line-height: 1.3;
        }

        .logo span {
            color: #f1c40f;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .admin-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            flex: 1;
            min-width: 0;
        }

        .admin-badge i {
            color: #f1c40f;
            font-size: 0.9rem;
        }

        .admin-role {
            background: var(--success);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .btn {
            background: linear-gradient(to right, var(--secondary), var(--primary));
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            min-height: 44px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(to right, var(--success), #2ecc71);
        }

        .btn-danger {
            background: linear-gradient(to right, var(--accent), #c0392b);
        }

        .btn-warning {
            background: linear-gradient(to right, #f39c12, #e67e22);
        }

        .btn-info {
            background: linear-gradient(to right, var(--info), #138496);
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 15px auto;
            padding: 0 12px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.12);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        .card h2 i {
            color: var(--secondary);
            font-size: 1.2rem;
        }

        /* Admin Controls */
        .admin-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .admin-controls .btn {
            width: 100%;
            margin-bottom: 5px;
        }

        .data-management-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        .delete-section {
            border: 2px solid #ffeaea;
            border-radius: 8px;
            padding: 15px;
            background: #fff5f5;
            margin-bottom: 10px;
        }

        .delete-section h3 {
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .delete-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .delete-option {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        @media (min-width: 768px) {
            .delete-option {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .delete-info {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 0;
        }

        .file-upload:hover {
            border-color: var(--secondary);
            background: rgba(52, 152, 219, 0.05);
        }

        .file-upload i {
            font-size: 2.5rem;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        /* Batch Selector Grid */
        .batch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 6px;
            margin-top: 8px;
            max-height: 120px;
            overflow-y: auto;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .batch-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            padding: 4px;
            background: white;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .batch-checkbox input {
            margin: 0;
            transform: scale(1.2);
        }

        .select-all-batches {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #e8f4fc;
            border-radius: 5px;
        }

        /* Add Batch Button */
        .add-batch-btn {
            background: linear-gradient(to right, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            min-height: 44px;
        }

        .add-batch-btn:hover {
            background: linear-gradient(to right, #229954, #27ae60);
            transform: translateY(-2px);
        }

        /* Batch Management Styles */
        .batch-management {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .batch-input-group {
            display: flex;
            gap: 5px;
            width: 100%;
        }

        .custom-batch-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            min-height: 44px;
        }

        /* Custom Batch List */
        .custom-batch-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            max-height: 120px;
            overflow-y: auto;
        }

        .batch-tag {
            background: linear-gradient(to right, var(--secondary), var(--primary));
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 32px;
        }

        .batch-tag:hover {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }

        .batch-tag i {
            font-size: 0.8rem;
        }

        /* Books List */
        .books-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        @media (min-width: 480px) {
            .books-list {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        .book-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--secondary);
            position: relative;
        }

        .book-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
        }

        .action-btn {
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            color: var(--dark);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            min-height: 36px;
        }

        .action-btn i {
            font-size: 0.9rem;
        }

        .action-btn:hover {
            background: var(--secondary);
            color: white;
        }

        .delete-btn:hover {
            background: var(--accent);
        }

        .book-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 8px;
        }

        .available {
            background: #d5f4e6;
            color: var(--success);
        }

        .unavailable {
            background: #ffeaea;
            color: var(--accent);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--dark);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
            min-height: 44px;
        }

        .form-control:focus {
            border-color: var(--secondary);
            outline: none;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 12px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--success), #2ecc71);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* Enhanced Progress Bar for Large Uploads */
        .progress-container-large {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            margin: 15px 0;
            overflow: hidden;
            display: none;
            position: relative;
        }

        .progress-bar-large {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            position: relative;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            padding: 0 5px;
        }

        /* Search Bar */
        .search-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        @media (min-width: 480px) {
            .search-container {
                flex-direction: row;
                gap: 8px;
            }
        }

        .search-container .form-control {
            flex: 1;
        }

        /* Delete All Button */
        .delete-all-btn {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            min-height: 44px;
        }

        .delete-all-btn:hover {
            background: linear-gradient(to right, #c0392b, #a93226);
            transform: translateY(-2px);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 12px;
            background: #f1f1f1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-btn.active {
            background: var(--secondary);
            color: white;
        }

        .page-btn:hover:not(.active) {
            background: #ddd;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Notifications */
        .notifications {
            position: fixed;
            top: 80px;
            right: 10px;
            left: 10px;
            z-index: 999;
            max-width: none;
        }

        @media (min-width: 768px) {
            .notifications {
                top: 100px;
                right: 20px;
                left: auto;
                max-width: 400px;
            }
        }

        .notification {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--accent);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification.info {
            border-left-color: var(--info);
        }

        .notification-content {
            flex: 1;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 10px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Database Status */
        .db-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 15px;
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
            margin-top: 5px;
        }

        .db-status.connected {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .db-status.disconnected {
            background: rgba(231, 76, 60, 0.1);
            color: var(--accent);
        }

        /* Database Stats */
        .db-stats {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 10px 0;
            border-left: 4px solid var(--info);
        }

        .db-stats h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #eaeaea;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 3px;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px 15px;
            color: var(--primary);
            margin-top: 30px;
            border-top: 1px solid #ddd;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        /* Mobile Menu */
        .mobile-menu-btn {
            display: block;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            border: none;
            font-size: 1.5rem;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .mobile-menu-btn {
                display: none;
            }
        }

        .mobile-admin-menu {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 999;
            width: 250px;
            padding: 15px;
        }

        .mobile-admin-menu.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .mobile-menu-item {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            text-align: left;
            background: #f8f9fa;
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 44px;
        }

        .mobile-menu-item i {
            width: 20px;
            font-size: 1rem;
        }

        /* Responsive Improvements for Larger Screens */
        @media (min-width: 768px) {
            html {
                font-size: 16px;
            }
            
            header {
                padding: 15px 30px;
            }
            
            .header-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .logo h1 {
                font-size: 1.8rem;
            }
            
            .logo i {
                font-size: 2.5rem;
            }
            
            .admin-info {
                justify-content: flex-end;
            }
            
            .admin-badge {
                flex: 0 1 auto;
            }
            
            .header-actions {
                width: auto;
                gap: 15px;
            }
            
            .btn {
                flex: none;
                padding: 10px 20px;
                font-size: 1rem;
            }
            
            .container {
                margin: 30px auto;
                padding: 0 20px;
            }
            
            .dashboard {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 25px;
                margin-bottom: 40px;
            }
            
            .card {
                padding: 25px;
            }
            
            .card h2 {
                font-size: 1.3rem;
            }
            
            .admin-controls {
                flex-direction: row;
                gap: 15px;
            }
            
            .admin-controls .btn {
                width: auto;
                margin-bottom: 0;
            }
            
            .delete-option {
                flex-direction: row;
            }
            
            .batch-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 8px;
                max-height: 150px;
            }
            
            .batch-management {
                flex-direction: row;
            }
            
            .custom-batch-list {
                max-height: 150px;
            }
            
            .books-list {
                gap: 20px;
            }
            
            .modal-content {
                padding: 30px;
            }
            
            footer {
                padding: 25px;
                font-size: 1rem;
            }
        }

        @media (min-width: 1024px) {
            .dashboard {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            }
            
            .container {
                max-width: 1400px;
            }
        }

        /* Fix for iOS Safari */
        @supports (-webkit-touch-callout: none) {
            input, select, textarea {
                font-size: 16px; /* Prevents auto-zoom on iOS */
            }
            
            .btn, .action-btn, .page-btn, .notification-close, .close-modal {
                cursor: pointer;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn, .action-btn, .page-btn, .notification-close, .close-modal, 
            .mobile-menu-item, .batch-tag, .delete-all-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .form-control {
                min-height: 44px;
            }
            
            input[type="checkbox"],
            input[type="radio"] {
                transform: scale(1.3);
                margin-right: 8px;
            }
            
            .action-btn {
                width: 44px;
                height: 44px;
            }
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .batch-grid::-webkit-scrollbar,
        .custom-batch-list::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .batch-grid::-webkit-scrollbar-track,
        .custom-batch-list::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .batch-grid::-webkit-scrollbar-thumb,
        .custom-batch-list::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .batch-grid::-webkit-scrollbar-thumb:hover,
        .custom-batch-list::-webkit-scrollbar-thumb:hover,
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-book-open"></i>
                <div>
                    <h1>ECE Department <span>Library</span> - Admin Dashboard</h1>
                    <span id="dbStatus" class="db-status disconnected">
                        <i class="fas fa-circle"></i> Firebase
                    </span>
                </div>
            </div>
            <div class="admin-info">
                <div class="admin-badge" id="adminBadge">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminEmail"></span>
                    <span class="admin-role" id="adminRole">Admin</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-danger" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <button class="btn" onclick="window.location.href='index.html'">
                        <i class="fas fa-home"></i> Public View
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <div class="mobile-admin-menu" id="mobileAdminMenu">
        <button class="mobile-menu-item" onclick="document.getElementById('addBookBtn').click()">
            <i class="fas fa-plus"></i> Add Book
        </button>
        <button class="mobile-menu-item" onclick="document.getElementById('addJournalBtn').click()">
            <i class="fas fa-link"></i> Add Journal
        </button>
        <button class="mobile-menu-item" onclick="document.getElementById('exportBooksBtn').click()">
            <i class="fas fa-download"></i> Export Excel
        </button>
        <button class="mobile-menu-item" onclick="document.getElementById('syncDataBtn').click()">
            <i class="fas fa-sync-alt"></i> Sync Data
        </button>
        <button class="mobile-menu-item" onclick="window.location.href='index.html'">
            <i class="fas fa-home"></i> Public View
        </button>
        <button class="mobile-menu-item" onclick="document.getElementById('logoutBtn').click()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>

    <!-- Notifications Container -->
    <div class="notifications" id="notificationsContainer"></div>

    <!-- Edit Book Modal -->
    <div id="editBookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Edit Book</h2>
                <button class="close-modal" id="closeEditModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="editBookTitle">Book Title</label>
                <input type="text" id="editBookTitle" class="form-control">
            </div>
            <div class="form-group">
                <label for="editBookAuthor">Author</label>
                <input type="text" id="editBookAuthor" class="form-control">
            </div>
            <div class="form-group">
                <label for="editBookStatus">Availability</label>
                <select id="editBookStatus" class="form-control">
                    <option value="available">Available</option>
                    <option value="unavailable">Not Available</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editBookIsbn">ISBN (Optional)</label>
                <input type="text" id="editBookIsbn" class="form-control">
            </div>
            <div class="form-group">
                <label for="editBookYear">Year (Optional)</label>
                <input type="number" id="editBookYear" class="form-control">
            </div>
            <input type="hidden" id="editBookId">
            <button class="btn btn-success" id="saveBookChanges">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>

    <!-- Delete Projects Modal -->
    <div id="deleteProjectsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-trash"></i> Delete Projects by Batch</h2>
                <button class="close-modal" id="closeProjectsModal">&times;</button>
            </div>
            <div class="form-group">
                <label>Select Batches to Delete:</label>
                <div class="select-all-batches">
                    <input type="checkbox" id="selectAllBatches">
                    <label for="selectAllBatches">Select All Batches</label>
                </div>
                <div class="batch-grid" id="batchSelectionGrid">
                    <!-- Batches will be populated here -->
                </div>
            </div>
            <div class="form-group">
                <p id="selectedBatchesInfo">No batches selected</p>
                <p id="projectsCountInfo">0 projects will be deleted</p>
            </div>
            <button class="btn btn-danger" id="confirmDeleteProjects">
                <i class="fas fa-trash"></i> Delete Selected Batches
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <h1 style="color: var(--primary); margin-bottom: 20px; font-size: 1.5rem; display: flex; flex-direction: column; gap: 10px;">
            <span><i class="fas fa-tachometer-alt"></i> Admin Dashboard</span>
            <button class="btn btn-info" id="syncDataBtn" style="align-self: flex-start;">
                <i class="fas fa-sync-alt"></i> Sync Now
            </button>
        </h1>
       
        <div class="admin-controls">
            <button class="btn btn-success" id="addBookBtn"><i class="fas fa-plus"></i> Add Book</button>
            <button class="btn btn-success" id="addJournalBtn"><i class="fas fa-link"></i> Add Journal</button>
            <button class="btn btn-warning" id="exportBooksBtn">
                <i class="fas fa-download"></i> Export to Excel
            </button>
            <button class="btn btn-info" id="refreshBooksBtn">
                <i class="fas fa-redo"></i> Refresh Books
            </button>
        </div>

        <!-- Database Stats -->
        <div class="db-stats" id="dbStats">
            <h3><i class="fas fa-chart-bar"></i> Database Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="statsBooksCount">0</div>
                    <div class="stat-label">Total Books</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statsJournalsCount">0</div>
                    <div class="stat-label">Journal Links</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statsExamsCount">0</div>
                    <div class="stat-label">Exam Papers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statsProjectsCount">0</div>
                    <div class="stat-label">Projects</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statsLastUpdated">--:--</div>
                    <div class="stat-label">Last Updated</div>
                </div>
            </div>
        </div>

        <!-- Data Management Section -->
        <div class="data-management-section">
            <div class="card">
                <h2><i class="fas fa-trash-alt"></i> Data Management</h2>
                
                <!-- Delete Books Only -->
                <div class="delete-section">
                    <h3><i class="fas fa-book"></i> Delete Books Only</h3>
                    <div class="delete-option">
                        <div>
                            <strong>Delete All Books</strong>
                            <div class="delete-info">This will delete all books from the database</div>
                        </div>
                        <button class="btn btn-danger" id="deleteBooksBtn">
                            <i class="fas fa-trash"></i> Delete <span id="booksCount">0</span> Books
                        </button>
                    </div>
                </div>

                <!-- Delete Journals Only -->
                <div class="delete-section">
                    <h3><i class="fas fa-newspaper"></i> Delete Journals Only</h3>
                    <div class="delete-option">
                        <div>
                            <strong>Delete All Journal Links</strong>
                            <div class="delete-info">This will delete all journal links from the database</div>
                        </div>
                        <button class="btn btn-danger" id="deleteJournalsBtn">
                            <i class="fas fa-trash"></i> Delete <span id="journalsCount">0</span> Journals
                        </button>
                    </div>
                </div>

                <!-- Delete Exams Only -->
                <div class="delete-section">
                    <h3><i class="fas fa-file-pdf"></i> Delete Exam Papers Only</h3>
                    <div class="delete-option">
                        <div>
                            <strong>Delete All Exam Papers</strong>
                            <div class="delete-info">This will delete all TNPSC exam paper links from the database</div>
                        </div>
                        <button class="btn btn-danger" id="deleteExamsBtn">
                            <i class="fas fa-trash"></i> Delete <span id="examsCount">0</span> Exam Papers
                        </button>
                    </div>
                </div>

                <!-- Delete Projects Only -->
                <div class="delete-section">
                    <h3><i class="fas fa-project-diagram"></i> Delete Projects Only</h3>
                    <div class="delete-option">
                        <div>
                            <strong>Delete Projects by Batch</strong>
                            <div class="delete-info">Select specific batches to delete projects</div>
                        </div>
                        <button class="btn btn-danger" id="deleteProjectsByBatchBtn">
                            <i class="fas fa-trash"></i> Delete Selected Projects
                        </button>
                    </div>
                </div>

                <!-- Clear ALL Data -->
                <div class="delete-section" style="border-color: var(--accent); background: #ffeded;">
                    <h3><i class="fas fa-exclamation-triangle"></i> Clear ALL Data</h3>
                    <div class="delete-option">
                        <div>
                            <strong>Delete EVERYTHING</strong>
                            <div class="delete-info" style="color: var(--accent); font-weight: bold;">
                                ⚠️ This will delete ALL books, journals, exam papers, projects, and messages!
                            </div>
                        </div>
                        <button class="btn btn-danger" id="clearAllDataBtn" style="background: linear-gradient(to right, #c0392b, #a93226);">
                            <i class="fas fa-bomb"></i> Nuke Everything
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <!-- Excel Upload - ENHANCED -->
            <div class="card">
                <h2><i class="fas fa-file-excel"></i> Excel File Upload (Bulk Import)</h2>
                <p style="margin-bottom: 10px; font-size: 0.9rem;">Upload Excel file with book data (.xlsx, .csv, .xls) - Supports 2000+ books</p>
                
                <!-- Enhanced Progress Bar -->
                <div class="progress-container-large" id="uploadProgress">
                    <div class="progress-bar-large" id="uploadProgressBar">0%</div>
                </div>
                <div class="progress-stats" id="uploadStats" style="display: none;">
                    <span>Processed: <span id="processedCount">0</span></span>
                    <span>Success: <span id="successCount">0</span></span>
                    <span>Failed: <span id="failedCount">0</span></span>
                    <span>Remaining: <span id="remainingCount">0</span></span>
                </div>
                
                <!-- File Upload Area -->
                <div class="file-upload" id="excelUpload">
                    <i class="fas fa-file-excel"></i>
                    <p>Drag & drop Excel file here or click to browse</p>
                    <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">Supports .xlsx, .xls, .csv files</p>
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" hidden>
                </div>
                
                <!-- Import Options -->
                <div class="form-group" style="margin-top: 15px;">
                    <label>Import Mode:</label>
                    <select id="importMode" class="form-control">
                        <option value="append">Append to existing books</option>
                        <option value="replace">Replace all books</option>
                    </select>
                </div>

                <!-- Batch Processing Options -->
                <div class="form-group">
                    <label>Batch Size:</label>
                    <select id="batchSize" class="form-control">
                        <option value="100">100 books per batch (Fast)</option>
                        <option value="200" selected>200 books per batch (Recommended)</option>
                        <option value="500">500 books per batch (For large files)</option>
                    </select>
                    <small style="color: #666; font-size: 0.8rem;">Larger batch = faster, but may timeout on slow connections</small>
                </div>
                
                <!-- Excel Template Info -->
                <div style="margin-top: 10px; font-size: 0.8rem; color: #666; line-height: 1.4; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <p style="font-weight: bold; margin-bottom: 5px;">Excel Template Format:</p>
                    <p style="margin-bottom: 3px;">• <strong>Title</strong> (Required) - Book title</p>
                    <p style="margin-bottom: 3px;">• <strong>Author</strong> (Required) - Author name</p>
                    <p style="margin-bottom: 3px;">• <strong>Status</strong> - "available" or "unavailable"</p>
                    <p style="margin-bottom: 3px;">• <strong>ISBN</strong> (Optional) - ISBN number</p>
                    <p>• <strong>Year</strong> (Optional) - Publication year</p>
                </div>
                
                <!-- Upload Button -->
                <button class="btn" style="margin-top: 15px; width: 100%;" onclick="document.getElementById('excelFile').click()">
                    <i class="fas fa-upload"></i> Upload Excel File
                </button>
                
                <!-- Download Sample Button -->
                <button class="btn btn-info" id="downloadSampleBtn" style="margin-top: 10px; width: 100%;">
                    <i class="fas fa-download"></i> Download Sample Excel
                </button>
            </div>

            <!-- Book Management -->
            <div class="card">
                <h2><i class="fas fa-book"></i> Add/Edit Book</h2>
                <div class="form-group">
                    <label>Book Title</label>
                    <input type="text" id="bookTitle" class="form-control" placeholder="Enter book title">
                </div>
                <div class="form-group">
                    <label>Author</label>
                    <input type="text" id="bookAuthor" class="form-control" placeholder="Enter author name">
                </div>
                <div class="form-group">
                    <label>Availability</label>
                    <select id="bookStatus" class="form-control">
                        <option value="available">Available</option>
                        <option value="unavailable">Not Available</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ISBN (Optional)</label>
                    <input type="text" id="bookIsbn" class="form-control" placeholder="Enter ISBN">
                </div>
                <div class="form-group">
                    <label>Year (Optional)</label>
                    <input type="number" id="bookYear" class="form-control" placeholder="Enter publication year" min="1800" max="2026">
                </div>
                <button class="btn" id="updateBookBtn"><i class="fas fa-save"></i> Save Book</button>
            </div>

            <!-- Book List for Admin -->
            <div class="card">
                <h2><i class="fas fa-list"></i> All Books (Editable)</h2>
                <div style="margin-bottom: 10px; font-size: 0.9rem; color: #666;">
                    Showing: <span id="currentBookCount">0</span> books | Total: <span id="totalBookCount">0</span> books
                </div>
                <div class="search-container">
                    <input type="text" id="adminBookSearch" class="form-control" placeholder="Search books by title, author, or ISBN...">
                    <button class="btn" id="adminBookSearchBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                    <div id="adminBooksList">
                        <!-- Admin book list will be populated here -->
                    </div>
                </div>
                <div class="pagination" id="adminBooksPagination">
                    <!-- Pagination will be added by JavaScript -->
                </div>
            </div>

            <!-- Project Management -->
            <div class="card">
                <h2><i class="fas fa-file-pdf"></i> Project Management</h2>
                <div class="form-group">
                    <label>Project Title</label>
                    <input type="text" id="projectTitle" class="form-control" placeholder="Enter project title">
                </div>
                
                <!-- Batch Management -->
                <div class="form-group">
                    <label>Select Batch</label>
                    <select id="projectBatch" class="form-control">
                        <option value="2026">2026 Batch</option>
                        <option value="2025">2025 Batch</option>
                        <option value="2024">2024 Batch</option>
                        <option value="2023">2023 Batch</option>
                        <option value="2022">2022 Batch</option>
                        <option value="2021">2021 Batch</option>
                        <option value="2020">2020 Batch</option>
                        <option value="2019">2019 Batch</option>
                        <option value="2018">2018 Batch</option>
                        <option value="custom">Add Custom Batch</option>
                    </select>
                </div>
                
                <!-- Custom Batch Input -->
                <div class="batch-management" id="customBatchSection" style="display: none;">
                    <div class="batch-input-group">
                        <input type="text" id="customBatchInput" class="custom-batch-input" placeholder="Enter batch year (e.g., 2050, 2100)">
                        <button class="btn btn-success" id="addCustomBatchBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <!-- Custom Batch List -->
                <div class="custom-batch-list" id="customBatchList">
                    <!-- Custom batches will appear here -->
                </div>
                <button class="btn" style="margin-top: 15px; width: 100%;" onclick="document.getElementById('pdfFile').click()">
                    <i class="fas fa-upload"></i> Upload Project PDF
                </button>
                
                <!-- Project List -->
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1rem;">Current Projects</h3>
                    <div id="adminProjectsList" style="max-height: 200px; overflow-y: auto;">
                        <!-- Admin project list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Journal Links Management - Research Journals -->
            <div class="card">
                <h2><i class="fas fa-link"></i> Journal Links Management - Research Journals</h2>
                <div class="form-group">
                    <label>Journal Name</label>
                    <input type="text" id="journalName" class="form-control" placeholder="Enter journal name">
                </div>
                <div class="form-group">
                    <label>Journal URL</label>
                    <input type="url" id="journalUrl" class="form-control" placeholder="https://example.com/journal">
                </div>
                <button class="btn" id="addJournalLinkBtn"><i class="fas fa-plus-circle"></i> Add Journal Link</button>
                
                <!-- Journal List -->
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1rem;">Current Journals</h3>
                    <div id="adminJournalsList" style="max-height: 200px; overflow-y: auto;">
                        <!-- Admin journal list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Journal Links Management - Exam Papers (TNPSC) -->
            <div class="card">
                <h2><i class="fas fa-file-pdf"></i>Competitive Exam Papers</h2>
                <div class="form-group">
                    <label>Exam Paper Name</label>
                    <input type="text" id="examName" class="form-control" placeholder="Enter exam paper name (e.g., Gate,TNPSC Group 1 2023)">
                </div>
                <div class="form-group">
                    <label>Exam Paper URL</label>
                    <input type="url" id="examUrl" class="form-control" placeholder="https://example.com/tnpsc-paper">
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <input type="text" id="examYear" class="form-control" placeholder="e.g., 2023, 2024">
                </div>
                <button class="btn" id="addExamLinkBtn"><i class="fas fa-plus-circle"></i> Add Exam Paper Link</button>
                
                <!-- Exam Papers List -->
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary); font-size: 1rem;">Current Exam Papers</h3>
                    <div id="adminExamsList" style="max-height: 200px; overflow-y: auto;">
                        <!-- Admin exam papers list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Scrolling Message Control -->
            <div class="card">
                <h2><i class="fas fa-bullhorn"></i> Scrolling Message</h2>
                <div class="form-group">
                    <label>Update Scrolling Message</label>
                    <textarea id="newMessage" class="form-control" rows="3" placeholder="Enter new scrolling message...">📚 Library Timings: 9 AM to 8 PM (Monday to Saturday) | 📖 New Arrivals: "Data Structures" & "Machine Learning Basics"</textarea>
                </div>
                <button class="btn" id="updateMessageBtn"><i class="fas fa-sync-alt"></i> Update Message</button>
            </div>
        </div>
    </div>

    <footer>
        <p>© 2026 Department Library Management System | Electronics And Communication Engineering Department</p>
        <p><i class="fas fa-envelope"></i> ecelibrary@department.edu | <i class="fas fa-envelope"></i>hod.ece@shanmugha.edu</p>
    </footer>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================

        const firebaseConfig = {
            apiKey: "AIzaSyAh99Zr_V2f7l_48U_5gYoNXgE9vodonsE",
            authDomain: "ece-library-d2948.firebaseapp.com",
            projectId: "ece-library-d2948",
            storageBucket: "ece-library-d2948.firebasestorage.app",
            messagingSenderId: "522135866665",
            appId: "1:522135866665:web:8fdde8c1c6611115f97b38"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ============================================
        // SESSION CHECK - MUST BE LOGGED IN
        // ============================================

        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'adminlogin.html';
                return;
            }

            const authorizedEmails = [
                "vinoth.ece@shanmugha.edu.in",
                "hod.ece@shanmugha.edu.in",
                "santhoshwebworker@gmail.com"
            ];

            if (!authorizedEmails.includes(user.email)) {
                await auth.signOut();
                localStorage.clear();
                window.location.href = 'adminlogin.html';
                return;
            }

            displayUserInfo(user);
            loadDashboardData();
        });

        function displayUserInfo(user) {
            document.getElementById('adminEmail').textContent = user.email;
            
            let role = 'Admin';
            if (user.email === 'hod.ece@shanmugha.edu.in') {
                role = 'HOD';
            } else if (user.email === 'santhoshwebworker@gmail.com') {
                role = 'Web Admin';
            }
            
            document.getElementById('adminRole').textContent = role;
        }

        // ============================================
        // NOTIFICATION SYSTEM
        // ============================================

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationsContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <strong>${type.toUpperCase()}:</strong> ${message}
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            container.appendChild(notification);
            
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            });
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // ============================================
        // GLOBAL DATA VARIABLES
        // ============================================

        let books = [];
        let projects = {};
        let journals = [];
        let exams = [];
        let adminCurrentPage = 1;
        let adminBooksPerPage = 10;
        let adminSearchQuery = '';
        let customBatches = [];

        // ============================================
        // ENHANCED FIREBASE FUNCTIONS FOR LARGE DATASETS
        // ============================================

        // Load all books with pagination (supports 2000+ books)
        async function loadBooksFromFirebase() {
            try {
                showNotification('Loading books...', 'info');
                
                let allBooks = [];
                let lastDoc = null;
                let batchCount = 0;
                const batchSize = 500; // Firestore max per query
                
                while (true) {
                    let query = db.collection("books")
                        .orderBy("addedDate", "desc")
                        .limit(batchSize);
                    
                    if (lastDoc) {
                        query = query.startAfter(lastDoc);
                    }
                    
                    const querySnapshot = await query.get();
                    
                    if (querySnapshot.empty) {
                        break;
                    }
                    
                    batchCount++;
                    const batchBooks = [];
                    querySnapshot.forEach(doc => {
                        batchBooks.push({ 
                            id: doc.id, 
                            ...doc.data(),
                            addedDate: doc.data().addedDate ? doc.data().addedDate.toDate() : new Date()
                        });
                    });
                    
                    allBooks = [...allBooks, ...batchBooks];
                    
                    showNotification(`Loaded ${allBooks.length} books... (Batch ${batchCount})`, 'info');
                    
                    if (querySnapshot.size < batchSize) {
                        break;
                    }
                    
                    lastDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                books = allBooks;
                console.log(`Total books loaded: ${books.length}`);
                
                updateStats();
                
                return books;
            } catch (error) {
                console.error("Error loading books:", error);
                showNotification(`Error loading books: ${error.message}`, 'error');
                throw error;
            }
        }

        // Load journals
        async function loadJournalsFromFirebase() {
            try {
                const querySnapshot = await db.collection("journals")
                    .orderBy("name")
                    .get();
                
                journals = [];
                querySnapshot.forEach(doc => {
                    journals.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Journals loaded: ${journals.length}`);
            } catch (error) {
                console.error("Error loading journals:", error);
                throw error;
            }
        }

        // Load exam papers
        async function loadExamsFromFirebase() {
            try {
                const querySnapshot = await db.collection("exams")
                    .orderBy("year", "desc")
                    .get();
                
                exams = [];
                querySnapshot.forEach(doc => {
                    exams.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Exam papers loaded: ${exams.length}`);
            } catch (error) {
                console.error("Error loading exams:", error);
                throw error;
            }
        }

        // Load projects
        async function loadProjectsFromFirebase() {
            try {
                const querySnapshot = await db.collection("projects").get();
                projects = {};
                querySnapshot.forEach(doc => {
                    const project = doc.data();
                    const batch = project.batch || "2026";
                    if (!projects[batch]) projects[batch] = [];
                    projects[batch].push({ id: doc.id, ...project });
                });
                
                querySnapshot.forEach(doc => {
                    const project = doc.data();
                    if (project.batch && !customBatches.includes(project.batch)) {
                        const defaultBatches = ['2026', '2025', '2024', '2023', '2022', '2021', '2020', '2019', '2018'];
                        if (!defaultBatches.includes(project.batch) && /^\d{4}$/.test(project.batch)) {
                            customBatches.push(project.batch);
                        }
                    }
                });
                
                customBatches = [...new Set(customBatches)];
                saveCustomBatches();
                renderCustomBatches();
                
            } catch (error) {
                console.error("Error loading projects:", error);
                throw error;
            }
        }

        // Load scrolling message
        async function loadScrollingMessage() {
            try {
                const doc = await db.collection("settings").doc("scrolling_message").get();
                if (doc.exists && doc.data().message) {
                    document.getElementById('newMessage').value = doc.data().message;
                }
            } catch (error) {
                console.error("Error loading scrolling message:", error);
            }
        }

        // ============================================
        // CUSTOM BATCH MANAGEMENT
        // ============================================

        function loadCustomBatches() {
            const savedBatches = localStorage.getItem('customBatches');
            if (savedBatches) {
                customBatches = JSON.parse(savedBatches);
            }
            renderCustomBatches();
        }

        function saveCustomBatches() {
            localStorage.setItem('customBatches', JSON.stringify(customBatches));
        }

        function renderCustomBatches() {
            const customBatchList = document.getElementById('customBatchList');
            const projectBatchSelect = document.getElementById('projectBatch');
            
            Array.from(projectBatchSelect.options).forEach(option => {
                if (option.value === 'custom') {
                    // Keep only the "Add Custom Batch" option
                }
            });
            
            customBatches.forEach(batch => {
                const optionExists = Array.from(projectBatchSelect.options).some(
                    opt => opt.value === batch
                );
                if (!optionExists && batch !== 'custom') {
                    const option = document.createElement('option');
                    option.value = batch;
                    option.textContent = `${batch} Batch`;
                    const customOption = projectBatchSelect.querySelector('option[value="custom"]');
                    projectBatchSelect.insertBefore(option, customOption);
                }
            });
            
            customBatchList.innerHTML = '';
            customBatches.forEach(batch => {
                if (batch !== 'custom') {
                    const batchTag = document.createElement('div');
                    batchTag.className = 'batch-tag';
                    batchTag.innerHTML = `
                        ${batch}
                        <i class="fas fa-times" onclick="removeCustomBatch('${batch}')"></i>
                    `;
                    customBatchList.appendChild(batchTag);
                }
            });
        }

        function addCustomBatch() {
            const customBatchInput = document.getElementById('customBatchInput');
            const batchValue = customBatchInput.value.trim();
            
            if (!batchValue) {
                showNotification('Please enter a batch year!', 'warning');
                return;
            }
            
            if (!/^\d{4}$/.test(batchValue)) {
                showNotification('Please enter a valid 4-digit year (e.g., 2050)!', 'warning');
                return;
            }
            
            const year = parseInt(batchValue);
            if (year < 1900 || year > 2200) {
                showNotification('Please enter a year between 1900 and 2200!', 'warning');
                return;
            }
            
            if (customBatches.includes(batchValue)) {
                showNotification(`Batch ${batchValue} already exists!`, 'warning');
                return;
            }
            
            customBatches.push(batchValue);
            saveCustomBatches();
            renderCustomBatches();
            
            document.getElementById('projectBatch').value = batchValue;
            customBatchInput.value = '';
            document.getElementById('customBatchSection').style.display = 'none';
            
            showNotification(`Batch ${batchValue} added successfully!`, 'success');
        }

        function removeCustomBatch(batch) {
            if (confirm(`Remove batch ${batch}? This won't delete existing projects in this batch.`)) {
                customBatches = customBatches.filter(b => b !== batch);
                saveCustomBatches();
                renderCustomBatches();
                showNotification(`Batch ${batch} removed!`, 'success');
            }
        }

        // ============================================
        // DASHBOARD FUNCTIONS
        // ============================================

        async function loadDashboardData() {
            try {
                showNotification('Loading dashboard data...', 'info');
                updateDbStatus(true);
                
                await Promise.all([
                    loadBooksFromFirebase(),
                    loadProjectsFromFirebase(),
                    loadJournalsFromFirebase(),
                    loadExamsFromFirebase(),
                    loadScrollingMessage()
                ]);
                
                loadAdminBooksList();
                loadAdminProjectsList();
                loadAdminJournalsList();
                loadAdminExamsList();
                updateDeleteCounts();
                updateStats();
                
                showNotification(`✅ Dashboard loaded! ${books.length} books, ${journals.length} journals, ${exams.length} exam papers`, 'success');
                
                document.getElementById('statsLastUpdated').textContent = 
                    new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                updateDbStatus(false);
                showNotification('Failed to load data from Firebase', 'error');
            }
        }

        function updateDbStatus(connected) {
            const statusEl = document.getElementById('dbStatus');
            if (connected) {
                statusEl.className = 'db-status connected';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Firebase Connected';
            } else {
                statusEl.className = 'db-status disconnected';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Firebase Disconnected';
            }
        }

        function updateDeleteCounts() {
            document.getElementById('booksCount').textContent = books.length;
            document.getElementById('journalsCount').textContent = journals.length;
            document.getElementById('examsCount').textContent = exams.length;
        }

        function updateStats() {
            document.getElementById('statsBooksCount').textContent = books.length;
            document.getElementById('statsJournalsCount').textContent = journals.length;
            document.getElementById('statsExamsCount').textContent = exams.length;
            document.getElementById('statsProjectsCount').textContent = 
                Object.values(projects).reduce((sum, arr) => sum + arr.length, 0);
            
            document.getElementById('totalBookCount').textContent = books.length;
            document.getElementById('currentBookCount').textContent = 
                Math.min(adminBooksPerPage, books.length);
        }

        // ============================================
        // EXCEL IMPORT FUNCTIONS
        // ============================================

        document.getElementById('excelFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const uploadProgress = document.getElementById('uploadProgress');
            const uploadProgressBar = document.getElementById('uploadProgressBar');
            const uploadStats = document.getElementById('uploadStats');
            
            uploadProgress.style.display = 'block';
            uploadStats.style.display = 'flex';
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.textContent = '0%';
            
            document.getElementById('processedCount').textContent = '0';
            document.getElementById('successCount').textContent = '0';
            document.getElementById('failedCount').textContent = '0';
            document.getElementById('remainingCount').textContent = '0';

            const importMode = document.getElementById('importMode').value;
            const batchSize = parseInt(document.getElementById('batchSize').value);
            const reader = new FileReader();

            reader.onload = async function(event) {
                try {
                    showNotification('Reading Excel file...', 'info');
                    
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    if (rows.length === 0) {
                        showNotification('❌ Excel file is empty!', 'error');
                        uploadProgress.style.display = 'none';
                        uploadStats.style.display = 'none';
                        return;
                    }

                    showNotification(`Found ${rows.length} rows in Excel`, 'info');

                    const firstRow = rows[0];
                    const hasTitle = firstRow.Title || firstRow.title || firstRow['Book Title'] || firstRow['Book Title'];
                    if (!hasTitle) {
                        showNotification('❌ Excel file must have "Title" column!', 'error');
                        uploadProgress.style.display = 'none';
                        uploadStats.style.display = 'none';
                        return;
                    }

                    const bookDataArray = [];
                    let validRows = 0;
                    
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        
                        const title = String(
                            row.Title || 
                            row.title || 
                            row['Book Title'] || 
                            row['Book Title'] || 
                            ''
                        ).trim();
                        
                        if (!title) continue;
                        
                        const author = String(
                            row.Author || 
                            row.author || 
                            row['Author Name'] || 
                            row['Author'] || 
                            'Unknown'
                        ).trim();
                        
                        let status = String(
                            row.Status || 
                            row.status || 
                            row.Availability || 
                            row.availability ||
                            "available"
                        ).toLowerCase().trim();
                        
                        if (!['available', 'unavailable'].includes(status)) {
                            status = 'available';
                        }
                        
                        const isbn = String(
                            row.ISBN || 
                            row.isbn || 
                            row['ISBN Number'] || 
                            row['ISBN'] ||
                            ""
                        ).trim();
                        
                        let year = row.Year || row.year || row.Year || new Date().getFullYear();
                        if (typeof year === 'string') {
                            year = parseInt(year) || new Date().getFullYear();
                        }
                        if (year < 1800 || year > 2100) {
                            year = new Date().getFullYear();
                        }

                        const bookData = {
                            title: title,
                            author: author,
                            status: status,
                            isbn: isbn,
                            year: year
                        };

                        bookDataArray.push(bookData);
                        validRows++;
                    }

                    showNotification(`Processing ${validRows} valid books...`, 'info');
                    document.getElementById('remainingCount').textContent = validRows;

                    if (importMode === 'replace' && books.length > 0) {
                        const confirmation = confirm(`Replace ${books.length} existing books with ${validRows} new books?`);
                        if (confirmation) {
                            showNotification('Clearing existing books...', 'info');
                            const deleteBatchSize = 500;
                            for (let i = 0; i < books.length; i += deleteBatchSize) {
                                const batch = db.batch();
                                const chunk = books.slice(i, i + deleteBatchSize);
                                chunk.forEach(book => {
                                    const docRef = db.collection("books").doc(book.id);
                                    batch.delete(docRef);
                                });
                                await batch.commit();
                                await new Promise(resolve => setTimeout(resolve, 300));
                            }
                            books = [];
                        } else {
                            showNotification('Import cancelled', 'info');
                            uploadProgress.style.display = 'none';
                            uploadStats.style.display = 'none';
                            return;
                        }
                    }

                    const result = await importBooksBatch(bookDataArray, batchSize);
                    
                    uploadProgressBar.style.width = '100%';
                    uploadProgressBar.textContent = '100%';
                    
                    await loadBooksFromFirebase();
                    loadAdminBooksList();
                    updateDeleteCounts();
                    updateStats();
                    
                    setTimeout(() => {
                        uploadProgress.style.display = 'none';
                        uploadStats.style.display = 'none';
                    }, 2000);
                    
                    showNotification(`✅ Import Complete!\n\n` +
                          `• Total rows processed: ${rows.length}\n` +
                          `• Valid books: ${validRows}\n` +
                          `• Successfully imported: ${result.successCount}\n` +
                          `• Failed: ${result.failedCount}\n` +
                          `• Total books now: ${books.length}`, 'success');

                } catch (error) {
                    console.error('Excel import error:', error);
                    uploadProgress.style.display = 'none';
                    uploadStats.style.display = 'none';
                    showNotification(`❌ Error importing Excel file:\n${error.message}`, 'error');
                }
            };

            reader.onerror = function() {
                uploadProgress.style.display = 'none';
                uploadStats.style.display = 'none';
                showNotification('❌ Error reading the Excel file', 'error');
            };

            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });

        async function importBooksBatch(bookDataArray, batchSize = 200) {
            try {
                const totalBooks = bookDataArray.length;
                let successCount = 0;
                let failedCount = 0;
                
                for (let i = 0; i < totalBooks; i += batchSize) {
                    const batch = bookDataArray.slice(i, i + batchSize);
                    const batchNumber = Math.floor(i / batchSize) + 1;
                    const totalBatches = Math.ceil(totalBooks / batchSize);
                    
                    const progress = Math.round((i / totalBooks) * 100);
                    document.getElementById('uploadProgressBar').style.width = `${progress}%`;
                    document.getElementById('uploadProgressBar').textContent = `${progress}%`;
                    
                    document.getElementById('processedCount').textContent = i + batch.length;
                    document.getElementById('remainingCount').textContent = totalBooks - (i + batch.length);
                    
                    showNotification(`Processing batch ${batchNumber}/${totalBatches}...`, 'info');
                    
                    const batchWrite = db.batch();
                    const booksCollection = db.collection("books");
                    
                    batch.forEach(bookData => {
                        const docRef = booksCollection.doc();
                        const bookWithMetadata = {
                            ...bookData,
                            addedDate: firebase.firestore.FieldValue.serverTimestamp(),
                            addedBy: auth.currentUser.email,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                            importedFromExcel: true,
                            importDate: new Date().toISOString()
                        };
                        batchWrite.set(docRef, bookWithMetadata);
                    });
                    
                    try {
                        await batchWrite.commit();
                        successCount += batch.length;
                        document.getElementById('successCount').textContent = successCount;
                    } catch (batchError) {
                        console.error(`Error in batch ${batchNumber}:`, batchError);
                        failedCount += batch.length;
                        document.getElementById('failedCount').textContent = failedCount;
                        
                        for (const bookData of batch) {
                            try {
                                await db.collection("books").add({
                                    ...bookData,
                                    addedDate: firebase.firestore.FieldValue.serverTimestamp(),
                                    addedBy: auth.currentUser.email,
                                    importedFromExcel: true
                                });
                                successCount++;
                            } catch (individualError) {
                                failedCount++;
                                console.error("Individual book error:", individualError);
                            }
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                return { successCount, failedCount };
            } catch (error) {
                console.error("Batch import error:", error);
                throw error;
            }
        }

        // Download sample Excel template
        document.getElementById('downloadSampleBtn').addEventListener('click', function() {
            try {
                const sampleData = [
                    {
                        "Title": "Digital Signal Processing",
                        "Author": "John G. Proakis",
                        "Status": "available",
                        "ISBN": "9780131873742",
                        "Year": 2007
                    },
                    {
                        "Title": "Communication Systems",
                        "Author": "Simon Haykin",
                        "Status": "available", 
                        "ISBN": "9780471697909",
                        "Year": 2009
                    },
                    {
                        "Title": "Electronic Devices and Circuit Theory",
                        "Author": "Robert L. Boylestad",
                        "Status": "unavailable",
                        "ISBN": "9780132622264",
                        "Year": 2012
                    }
                ];
                
                const ws = XLSX.utils.json_to_sheet(sampleData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Books");
                
                const wscols = [
                    { wch: 40 },
                    { wch: 30 },
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 10 }
                ];
                ws['!cols'] = wscols;
                
                XLSX.writeFile(wb, "ECE_Library_Excel_Template.xlsx");
                showNotification('✅ Sample Excel template downloaded!', 'success');
            } catch (error) {
                console.error('Error downloading sample:', error);
                showNotification('❌ Error downloading sample template', 'error');
            }
        });

        // ============================================
        // DELETE FUNCTIONS
        // ============================================

        async function deleteBooksOnly() {
            if (books.length === 0) {
                showNotification('No books to delete!', 'warning');
                return;
            }
            
            const confirmation = prompt(`⚠️ DELETE ALL ${books.length} BOOKS?\n\nType "DELETE ${books.length} BOOKS" to confirm`);
            
            if (confirmation === `DELETE ${books.length} BOOKS`) {
                try {
                    showNotification(`Deleting ${books.length} books...`, 'info');
                    
                    const batchSize = 500;
                    for (let i = 0; i < books.length; i += batchSize) {
                        const batch = db.batch();
                        const chunk = books.slice(i, i + batchSize);
                        chunk.forEach(book => {
                            const docRef = db.collection("books").doc(book.id);
                            batch.delete(docRef);
                        });
                        await batch.commit();
                        
                        const progress = Math.round((Math.min(i + batchSize, books.length) / books.length) * 100);
                        showNotification(`Deleting... ${progress}% complete`, 'info');
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    
                    await loadBooksFromFirebase();
                    loadAdminBooksList();
                    updateDeleteCounts();
                    updateStats();
                    
                    showNotification(`✅ Successfully deleted ${books.length} books!`, 'success');
                } catch (error) {
                    console.error('Error deleting books:', error);
                    showNotification('❌ Failed to delete books', 'error');
                }
            } else {
                showNotification('Book deletion cancelled', 'info');
            }
        }

        async function deleteJournalsOnly() {
            if (journals.length === 0) {
                showNotification('No journals to delete!', 'warning');
                return;
            }
            
            const confirmation = prompt(`⚠️ DELETE ALL ${journals.length} JOURNAL LINKS?\n\nType "DELETE ${journals.length} JOURNALS" to confirm`);
            
            if (confirmation === `DELETE ${journals.length} JOURNALS`) {
                try {
                    showNotification(`Deleting ${journals.length} journals...`, 'info');
                    
                    const batch = db.batch();
                    journals.forEach(journal => {
                        const docRef = db.collection("journals").doc(journal.id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                    
                    await loadJournalsFromFirebase();
                    loadAdminJournalsList();
                    updateDeleteCounts();
                    updateStats();
                    
                    showNotification(`✅ Successfully deleted ${journals.length} journal links!`, 'success');
                } catch (error) {
                    console.error('Error deleting journals:', error);
                    showNotification('❌ Failed to delete journals', 'error');
                }
            } else {
                showNotification('Journal deletion cancelled', 'info');
            }
        }

        async function deleteExamsOnly() {
            if (exams.length === 0) {
                showNotification('No exam papers to delete!', 'warning');
                return;
            }
            
            const confirmation = prompt(`⚠️ DELETE ALL ${exams.length} EXAM PAPER LINKS?\n\nType "DELETE ${exams.length} EXAMS" to confirm`);
            
            if (confirmation === `DELETE ${exams.length} EXAMS`) {
                try {
                    showNotification(`Deleting ${exams.length} exam papers...`, 'info');
                    
                    const batch = db.batch();
                    exams.forEach(exam => {
                        const docRef = db.collection("exams").doc(exam.id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                    
                    await loadExamsFromFirebase();
                    loadAdminExamsList();
                    updateDeleteCounts();
                    updateStats();
                    
                    showNotification(`✅ Successfully deleted ${exams.length} exam papers!`, 'success');
                } catch (error) {
                    console.error('Error deleting exams:', error);
                    showNotification('❌ Failed to delete exams', 'error');
                }
            } else {
                showNotification('Exam paper deletion cancelled', 'info');
            }
        }

        async function deleteProjectsByBatch() {
            const modal = document.getElementById('deleteProjectsModal');
            const batchGrid = document.getElementById('batchSelectionGrid');
            
            const allBatches = Object.keys(projects).sort((a, b) => b - a);
            
            if (allBatches.length === 0) {
                showNotification('No projects to delete!', 'warning');
                return;
            }
            
            batchGrid.innerHTML = '';
            allBatches.forEach(batch => {
                const projectCount = projects[batch] ? projects[batch].length : 0;
                if (projectCount > 0) {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'batch-checkbox';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="batch-${batch}" value="${batch}" data-count="${projectCount}">
                        <label for="batch-${batch}">${batch} (${projectCount})</label>
                    `;
                    batchGrid.appendChild(checkboxDiv);
                }
            });
            
            document.getElementById('selectAllBatches').addEventListener('change', function() {
                const checkboxes = batchGrid.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = this.checked);
                updateSelectedBatchesInfo();
            });
            
            batchGrid.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', updateSelectedBatchesInfo);
            });
            
            updateSelectedBatchesInfo();
            modal.style.display = 'flex';
        }

        function updateSelectedBatchesInfo() {
            const checkboxes = document.querySelectorAll('#batchSelectionGrid input[type="checkbox"]:checked');
            const selectedBatches = Array.from(checkboxes).map(cb => cb.value);
            const totalProjects = Array.from(checkboxes).reduce((sum, cb) => sum + parseInt(cb.dataset.count), 0);
            
            document.getElementById('selectedBatchesInfo').textContent = 
                `Selected: ${selectedBatches.length} batches`;
            document.getElementById('projectsCountInfo').textContent = 
                `${totalProjects} projects will be deleted`;
        }

        async function clearAllData() {
            const totalBooks = books.length;
            const totalJournals = journals.length;
            const totalExams = exams.length;
            const totalProjects = Object.values(projects).reduce((sum, arr) => sum + arr.length, 0);
            const totalItems = totalBooks + totalJournals + totalExams + totalProjects;
            
            if (totalItems === 0) {
                showNotification('No data to clear!', 'warning');
                return;
            }
            
            const confirmation = prompt(`⚠️ NUKE EVERYTHING?\n\n` +
                   `This will delete:\n` +
                   `• ${totalBooks} books\n` +
                   `• ${totalJournals} journals\n` +
                   `• ${totalExams} exam papers\n` +
                   `• ${totalProjects} projects\n` +
                   `• Scrolling message\n\n` +
                   `Type "NUKE ${totalItems} ITEMS" to confirm`);
            
            if (confirmation === `NUKE ${totalItems} ITEMS`) {
                try {
                    showNotification('Deleting ALL data...', 'info');
                    
                    if (totalBooks > 0) {
                        const deleteBatchSize = 500;
                        for (let i = 0; i < books.length; i += deleteBatchSize) {
                            const batch = db.batch();
                            const chunk = books.slice(i, i + deleteBatchSize);
                            chunk.forEach(book => {
                                const docRef = db.collection("books").doc(book.id);
                                batch.delete(docRef);
                            });
                            await batch.commit();
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    }
                    
                    if (totalJournals > 0) {
                        const journalsBatch = db.batch();
                        journals.forEach(journal => {
                            const docRef = db.collection("journals").doc(journal.id);
                            journalsBatch.delete(docRef);
                        });
                        await journalsBatch.commit();
                    }
                    
                    if (totalExams > 0) {
                        const examsBatch = db.batch();
                        exams.forEach(exam => {
                            const docRef = db.collection("exams").doc(exam.id);
                            examsBatch.delete(docRef);
                        });
                        await examsBatch.commit();
                    }
                    
                    if (totalProjects > 0) {
                        const projectsBatch = db.batch();
                        Object.values(projects).forEach(batchProjects => {
                            batchProjects.forEach(project => {
                                const docRef = db.collection("projects").doc(project.id);
                                projectsBatch.delete(docRef);
                            });
                        });
                        await projectsBatch.commit();
                    }
                    
                    customBatches = [];
                    saveCustomBatches();
                    renderCustomBatches();
                    
                    await db.collection("settings").doc("scrolling_message").set({
                        message: "📚 DEPARTMENT OF ELECTRONICS AND COMMUNICATION ENGINEERING DIGITAL LIBRARY",
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: auth.currentUser.email
                    });
                    
                    await loadDashboardData();
                    showNotification('✅ All data has been cleared successfully!', 'success');
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showNotification('❌ Error clearing data', 'error');
                }
            } else {
                showNotification('Data clearance cancelled', 'info');
            }
        }

        // ============================================
        // MOBILE MENU FUNCTIONALITY
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileAdminMenu = document.getElementById('mobileAdminMenu');
            
            if (mobileMenuBtn && mobileAdminMenu) {
                mobileMenuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    mobileAdminMenu.classList.toggle('show');
                });
                
                document.addEventListener('click', function(e) {
                    if (!mobileMenuBtn.contains(e.target) && !mobileAdminMenu.contains(e.target)) {
                        mobileAdminMenu.classList.remove('show');
                    }
                });
                
                mobileAdminMenu.querySelectorAll('.mobile-menu-item').forEach(item => {
                    item.addEventListener('click', function() {
                        mobileAdminMenu.classList.remove('show');
                    });
                });
            }
            
            loadCustomBatches();
            
            document.getElementById('projectBatch').addEventListener('change', function() {
                const customBatchSection = document.getElementById('customBatchSection');
                if (this.value === 'custom') {
                    customBatchSection.style.display = 'flex';
                    document.getElementById('customBatchInput').focus();
                } else {
                    customBatchSection.style.display = 'none';
                }
            });
            
            document.getElementById('addCustomBatchBtn').addEventListener('click', addCustomBatch);
            
            document.getElementById('customBatchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCustomBatch();
                }
            });
            
            function setVH() {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            setVH();
            window.addEventListener('resize', setVH);
            window.addEventListener('orientationchange', setVH);
        });

        // ============================================
        // DOM ELEMENTS & EVENT LISTENERS
        // ============================================

        const logoutBtn = document.getElementById('logoutBtn');
        const syncDataBtn = document.getElementById('syncDataBtn');
        const refreshBooksBtn = document.getElementById('refreshBooksBtn');
        const deleteBooksBtn = document.getElementById('deleteBooksBtn');
        const deleteJournalsBtn = document.getElementById('deleteJournalsBtn');
        const deleteExamsBtn = document.getElementById('deleteExamsBtn');
        const deleteProjectsByBatchBtn = document.getElementById('deleteProjectsByBatchBtn');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');
        const confirmDeleteProjects = document.getElementById('confirmDeleteProjects');
        const closeProjectsModal = document.getElementById('closeProjectsModal');
        const deleteProjectsModal = document.getElementById('deleteProjectsModal');

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                localStorage.clear();
                window.location.href = 'adminlogin.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Sync data
        syncDataBtn.addEventListener('click', loadDashboardData);

        // Refresh books
        refreshBooksBtn.addEventListener('click', async () => {
            showNotification('Refreshing books...', 'info');
            await loadBooksFromFirebase();
            loadAdminBooksList();
            updateStats();
            showNotification('Books refreshed!', 'success');
        });

        // Delete books only
        deleteBooksBtn.addEventListener('click', deleteBooksOnly);

        // Delete journals only
        deleteJournalsBtn.addEventListener('click', deleteJournalsOnly);

        // Delete exams only
        deleteExamsBtn.addEventListener('click', deleteExamsOnly);

        // Delete projects by batch
        deleteProjectsByBatchBtn.addEventListener('click', deleteProjectsByBatch);

        // Clear all data
        clearAllDataBtn.addEventListener('click', clearAllData);

        // Confirm delete selected projects
        confirmDeleteProjects.addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('#batchSelectionGrid input[type="checkbox"]:checked');
            const selectedBatches = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedBatches.length === 0) {
                showNotification('Please select at least one batch!', 'warning');
                return;
            }
            
            let totalProjects = 0;
            selectedBatches.forEach(batch => {
                totalProjects += projects[batch] ? projects[batch].length : 0;
            });
            
            const confirmation = prompt(`⚠️ DELETE ${totalProjects} PROJECTS FROM ${selectedBatches.length} BATCHES?\n\n` +
                   `Selected batches: ${selectedBatches.join(', ')}\n\n` +
                   `Type "DELETE ${totalProjects} PROJECTS" to confirm`);
            
            if (confirmation === `DELETE ${totalProjects} PROJECTS`) {
                try {
                    showNotification(`Deleting projects from ${selectedBatches.length} batches...`, 'info');
                    
                    let projectsToDelete = [];
                    selectedBatches.forEach(batch => {
                        if (projects[batch]) {
                            projects[batch].forEach(project => {
                                projectsToDelete.push({ id: project.id, batch: batch });
                            });
                        }
                    });
                    
                    const batchSize = 500;
                    for (let i = 0; i < projectsToDelete.length; i += batchSize) {
                        const batch = db.batch();
                        const chunk = projectsToDelete.slice(i, i + batchSize);
                        
                        chunk.forEach(project => {
                            const docRef = db.collection("projects").doc(project.id);
                            batch.delete(docRef);
                        });
                        
                        await batch.commit();
                    }
                    
                    deleteProjectsModal.style.display = 'none';
                    await loadProjectsFromFirebase();
                    loadAdminProjectsList();
                    updateDeleteCounts();
                    updateStats();
                    
                    showNotification(`✅ Successfully deleted ${totalProjects} projects from ${selectedBatches.length} batches!`, 'success');
                } catch (error) {
                    console.error('Error deleting projects:', error);
                    showNotification('❌ Failed to delete projects', 'error');
                }
            } else {
                showNotification('Project deletion cancelled', 'info');
            }
        });

        // Close projects modal
        closeProjectsModal.addEventListener('click', () => {
            deleteProjectsModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === deleteProjectsModal) {
                deleteProjectsModal.style.display = 'none';
            }
            if (e.target === editBookModal) {
                editBookModal.style.display = 'none';
            }
        });

        // ============================================
        // BOOK MANAGEMENT EVENT LISTENERS
        // ============================================

        const addBookBtn = document.getElementById('addBookBtn');
        const updateBookBtn = document.getElementById('updateBookBtn');
        const addJournalLinkBtn = document.getElementById('addJournalLinkBtn');
        const addExamLinkBtn = document.getElementById('addExamLinkBtn');
        const exportBooksBtn = document.getElementById('exportBooksBtn');
        const editBookModal = document.getElementById('editBookModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const saveBookChanges = document.getElementById('saveBookChanges');
        const adminBookSearch = document.getElementById('adminBookSearch');
        const adminBookSearchBtn = document.getElementById('adminBookSearchBtn');
        const updateMessageBtn = document.getElementById('updateMessageBtn');

        // Add book
        addBookBtn.addEventListener('click', async () => {
            const title = prompt("Enter book title:");
            const author = prompt("Enter author name:");
           
            if (title && author) {
                const newBook = {
                    title: title,
                    author: author,
                    status: 'available',
                    isbn: '',
                    year: new Date().getFullYear()
                };
                
                try {
                    await addBookToFirebase(newBook);
                    await loadBooksFromFirebase();
                    loadAdminBooksList();
                    updateDeleteCounts();
                    updateStats();
                } catch (error) {
                    console.error('Error adding book:', error);
                }
            }
        });

        // Add book from form
        updateBookBtn.addEventListener('click', async () => {
            const title = document.getElementById('bookTitle').value;
            const author = document.getElementById('bookAuthor').value;
            const status = document.getElementById('bookStatus').value;
            const isbn = document.getElementById('bookIsbn').value;
            const year = document.getElementById('bookYear').value;
           
            if (!title || !author) {
                showNotification('Please enter book title and author!', 'warning');
                return;
            }
            
            const bookData = {
                title: title.trim(),
                author: author.trim(),
                status: status,
                isbn: isbn.trim(),
                year: year ? parseInt(year) : new Date().getFullYear()
            };
            
            try {
                await addBookToFirebase(bookData);
                await loadBooksFromFirebase();
                loadAdminBooksList();
                updateDeleteCounts();
                updateStats();
                
                document.getElementById('bookTitle').value = '';
                document.getElementById('bookAuthor').value = '';
                document.getElementById('bookIsbn').value = '';
                document.getElementById('bookYear').value = '';
            } catch (error) {
                console.error('Error adding book:', error);
            }
        });

        // Edit book modal
        closeEditModal.addEventListener('click', () => {
            editBookModal.style.display = 'none';
        });

        saveBookChanges.addEventListener('click', async () => {
            const title = document.getElementById('editBookTitle').value;
            const author = document.getElementById('editBookAuthor').value;
            const status = document.getElementById('editBookStatus').value;
            const isbn = document.getElementById('editBookIsbn').value;
            const year = document.getElementById('editBookYear').value;
            const bookId = document.getElementById('editBookId').value;
           
            if (title && author && bookId) {
                const bookData = {
                    title: title,
                    author: author,
                    status: status,
                    isbn: isbn,
                    year: year ? parseInt(year) : undefined
                };
                
                try {
                    await updateBookInFirebase(bookId, bookData);
                    await loadBooksFromFirebase();
                    loadAdminBooksList();
                    editBookModal.style.display = 'none';
                } catch (error) {
                    console.error('Error updating book:', error);
                }
            }
        });

        // Add journal link
        addJournalLinkBtn.addEventListener('click', async () => {
            const name = document.getElementById('journalName').value;
            const url = document.getElementById('journalUrl').value;
           
            if (name && url) {
                try {
                    const journalData = {
                        name: name,
                        url: url,
                        addedDate: firebase.firestore.FieldValue.serverTimestamp(),
                        addedBy: auth.currentUser.email
                    };
                    
                    await db.collection("journals").add(journalData);
                    await loadJournalsFromFirebase();
                    loadAdminJournalsList();
                    updateDeleteCounts();
                    updateStats();
                    
                    document.getElementById('journalName').value = '';
                    document.getElementById('journalUrl').value = '';
                    
                    showNotification('Journal link added successfully!', 'success');
                } catch (error) {
                    console.error('Error adding journal:', error);
                    showNotification('Failed to add journal link', 'error');
                }
            } else {
                showNotification('Please enter journal name and URL!', 'warning');
            }
        });

        // Add exam paper link
        addExamLinkBtn.addEventListener('click', async () => {
            const name = document.getElementById('examName').value;
            const url = document.getElementById('examUrl').value;
            const year = document.getElementById('examYear').value;
           
            if (name && url) {
                try {
                    const examData = {
                        name: name,
                        url: url,
                        year: year || new Date().getFullYear().toString(),
                        addedDate: firebase.firestore.FieldValue.serverTimestamp(),
                        addedBy: auth.currentUser.email
                    };
                    
                    await db.collection("exams").add(examData);
                    await loadExamsFromFirebase();
                    loadAdminExamsList();
                    updateDeleteCounts();
                    updateStats();
                    
                    document.getElementById('examName').value = '';
                    document.getElementById('examUrl').value = '';
                    document.getElementById('examYear').value = '';
                    
                    showNotification('Exam paper link added successfully!', 'success');
                } catch (error) {
                    console.error('Error adding exam paper:', error);
                    showNotification('Failed to add exam paper link', 'error');
                }
            } else {
                showNotification('Please enter exam paper name and URL!', 'warning');
            }
        });

        // Export books to Excel
        exportBooksBtn.addEventListener('click', () => {
            if (books.length === 0) {
                showNotification('No books to export!', 'warning');
                return;
            }
            
            try {
                const exportData = books.map(book => ({
                    'Title': book.title,
                    'Author': book.author,
                    'Status': book.status,
                    'ISBN': book.isbn || '',
                    'Year': book.year || '',
                    'Added Date': book.addedDate ? book.addedDate.toLocaleDateString() : '',
                    'Added By': book.addedBy || ''
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Books");
                
                const wscols = [
                    { wch: 50 },
                    { wch: 30 },
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 10 },
                    { wch: 15 },
                    { wch: 25 }
                ];
                ws['!cols'] = wscols;
                
                const date = new Date();
                const filename = `ECE_Library_Books_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                showNotification(`✅ Exported ${books.length} books to Excel`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('❌ Error exporting books', 'error');
            }
        });

        // Update scrolling message
        updateMessageBtn.addEventListener('click', async () => {
            const newMessage = document.getElementById('newMessage').value;
            if (newMessage) {
                try {
                    await db.collection("settings").doc("scrolling_message").set({
                        message: newMessage,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: auth.currentUser.email
                    });
                    showNotification('Scrolling message updated successfully!', 'success');
                } catch (error) {
                    console.error('Error updating message:', error);
                    showNotification('Failed to update message', 'error');
                }
            }
        });

        // ============================================
        // BOOK MANAGEMENT FUNCTIONS
        // ============================================

        async function addBookToFirebase(bookData) {
            try {
                const bookWithMetadata = {
                    ...bookData,
                    addedDate: firebase.firestore.FieldValue.serverTimestamp(),
                    addedBy: auth.currentUser.email,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection("books").add(bookWithMetadata);
                showNotification(`Book "${bookData.title}" added successfully!`, 'success');
                return docRef.id;
            } catch (error) {
                console.error("Error adding book:", error);
                showNotification(`Failed to add book: ${error.message}`, 'error');
                throw error;
            }
        }

        async function updateBookInFirebase(bookId, bookData) {
            try {
                const updateData = {
                    ...bookData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: auth.currentUser.email
                };
                
                await db.collection("books").doc(bookId).update(updateData);
                showNotification(`Book "${bookData.title}" updated successfully!`, 'success');
            } catch (error) {
                console.error("Error updating book:", error);
                showNotification(`Failed to update book: ${error.message}`, 'error');
                throw error;
            }
        }

        async function deleteBookFromFirebase(bookId) {
            try {
                await db.collection("books").doc(bookId).delete();
                showNotification('Book deleted successfully!', 'success');
            } catch (error) {
                console.error("Error deleting book:", error);
                showNotification(`Failed to delete book: ${error.message}`, 'error');
                throw error;
            }
        }

        // ============================================
        // SEARCH FUNCTIONALITY
        // ============================================

        adminBookSearchBtn.addEventListener('click', () => {
            adminSearchQuery = adminBookSearch.value.toLowerCase().trim();
            adminCurrentPage = 1;
            loadAdminBooksList();
        });

        adminBookSearch.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                adminSearchQuery = adminBookSearch.value.toLowerCase().trim();
                adminCurrentPage = 1;
                loadAdminBooksList();
            }
        });

        // ============================================
        // LOAD UI FUNCTIONS
        // ============================================

        function loadAdminBooksList(page = 1) {
            adminCurrentPage = page;
            const adminBooksList = document.getElementById('adminBooksList');
            adminBooksList.innerHTML = '';
           
            let filteredBooks = books;
            if (adminSearchQuery) {
                filteredBooks = books.filter(book => 
                    book.title.toLowerCase().includes(adminSearchQuery) ||
                    (book.author && book.author.toLowerCase().includes(adminSearchQuery)) ||
                    (book.isbn && book.isbn.toLowerCase().includes(adminSearchQuery))
                );
            }
           
            if (filteredBooks.length === 0) {
                const message = adminSearchQuery 
                    ? `No books found for "${adminSearchQuery}"`
                    : 'No books in database';
                adminBooksList.innerHTML = `<p style="text-align: center; color: #666; padding: 20px;">${message}</p>`;
                document.getElementById('adminBooksPagination').innerHTML = '';
                document.getElementById('currentBookCount').textContent = '0';
                return;
            }
           
            const totalPages = Math.ceil(filteredBooks.length / adminBooksPerPage);
            const startIndex = (page - 1) * adminBooksPerPage;
            const endIndex = Math.min(startIndex + adminBooksPerPage, filteredBooks.length);
            const pageBooks = filteredBooks.slice(startIndex, endIndex);
           
            document.getElementById('currentBookCount').textContent = pageBooks.length;
           
            pageBooks.forEach(book => {
                const bookItem = document.createElement('div');
                bookItem.className = 'book-item';
                bookItem.innerHTML = `
                    <div class="book-actions">
                        <button class="action-btn edit-btn" onclick="openEditModal(${JSON.stringify(book).replace(/"/g, '&quot;')})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteSingleBook('${book.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3 style="font-size: 1rem; margin-bottom: 8px;">${book.title}</h3>
                    <p style="font-size: 0.9rem; margin-bottom: 5px;"><strong>Author:</strong> ${book.author}</p>
                    <p style="font-size: 0.9rem; margin-bottom: 5px;"><strong>Status:</strong> <span class="book-status ${book.status}">${book.status}</span></p>
                    ${book.isbn ? `<p style="font-size: 0.85rem; margin-bottom: 3px;"><strong>ISBN:</strong> ${book.isbn}</p>` : ''}
                    ${book.year ? `<p style="font-size: 0.85rem;"><strong>Year:</strong> ${book.year}</p>` : ''}
                    ${book.addedDate ? `<p style="font-size: 0.75rem; color: #888; margin-top: 8px;"><i class="fas fa-calendar"></i> Added: ${book.addedDate.toLocaleDateString()}</p>` : ''}
                `;
                adminBooksList.appendChild(bookItem);
            });
            
            const pagination = document.getElementById('adminBooksPagination');
            pagination.innerHTML = '';
            
            if (totalPages > 1) {
                if (page > 1) {
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'page-btn';
                    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    prevBtn.onclick = () => loadAdminBooksList(page - 1);
                    pagination.appendChild(prevBtn);
                }
                
                const pageInfo = document.createElement('span');
                pageInfo.style.padding = '8px 12px';
                pageInfo.style.fontSize = '0.85rem';
                pageInfo.textContent = `Page ${page} of ${totalPages}`;
                pagination.appendChild(pageInfo);
                
                if (page < totalPages) {
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'page-btn';
                    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    nextBtn.onclick = () => loadAdminBooksList(page + 1);
                    pagination.appendChild(nextBtn);
                }
            }
        }

        function loadAdminProjectsList() {
            const adminProjectsList = document.getElementById('adminProjectsList');
            adminProjectsList.innerHTML = '';
            
            let allProjects = [];
            
            Object.keys(projects).forEach(batch => {
                projects[batch].forEach(project => {
                    allProjects.push({
                        ...project,
                        batch: batch
                    });
                });
            });
            
            if (allProjects.length === 0) {
                adminProjectsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No projects available</p>';
                return;
            }
            
            allProjects.forEach(project => {
                const projectItem = document.createElement('div');
                projectItem.style.padding = '12px';
                projectItem.style.borderBottom = '1px solid #eee';
                projectItem.style.display = 'flex';
                projectItem.style.justifyContent = 'space-between';
                projectItem.style.alignItems = 'center';
                
                projectItem.innerHTML = `
                    <div style="flex: 1; min-width: 0;">
                        <strong style="font-size: 0.95rem; display: block; margin-bottom: 3px;">${project.title}</strong>
                        <div style="font-size: 0.8rem; color: #666;">
                            Batch: ${project.batch}
                        </div>
                    </div>
                    <div style="margin-left: 10px;">
                        <button class="action-btn delete-btn" onclick="deleteSingleProject('${project.id}', '${project.batch}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                adminProjectsList.appendChild(projectItem);
            });
        }

        function loadAdminJournalsList() {
            const adminJournalsList = document.getElementById('adminJournalsList');
            adminJournalsList.innerHTML = '';
           
            if (journals.length === 0) {
                adminJournalsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No journal links available</p>';
                return;
            }
           
            journals.forEach(journal => {
                const journalItem = document.createElement('div');
                journalItem.style.padding = '12px';
                journalItem.style.borderBottom = '1px solid #eee';
                journalItem.style.display = 'flex';
                journalItem.style.justifyContent = 'space-between';
                journalItem.style.alignItems = 'center';
                
                journalItem.innerHTML = `
                    <div style="flex: 1; min-width: 0;">
                        <strong style="font-size: 0.95rem; display: block; margin-bottom: 3px;">${journal.name}</strong>
                        <div style="font-size: 0.8rem; color: #666; word-break: break-all;">
                            ${journal.url}
                        </div>
                    </div>
                    <div style="margin-left: 10px;">
                        <button class="action-btn delete-btn" onclick="deleteSingleJournal('${journal.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                adminJournalsList.appendChild(journalItem);
            });
        }

        function loadAdminExamsList() {
            const adminExamsList = document.getElementById('adminExamsList');
            adminExamsList.innerHTML = '';
           
            if (exams.length === 0) {
                adminExamsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No exam papers available</p>';
                return;
            }
           
            exams.forEach(exam => {
                const examItem = document.createElement('div');
                examItem.style.padding = '12px';
                examItem.style.borderBottom = '1px solid #eee';
                examItem.style.display = 'flex';
                examItem.style.justifyContent = 'space-between';
                examItem.style.alignItems = 'center';
                
                examItem.innerHTML = `
                    <div style="flex: 1; min-width: 0;">
                        <strong style="font-size: 0.95rem; display: block; margin-bottom: 3px;">${exam.name}</strong>
                        <div style="font-size: 0.8rem; color: #666; word-break: break-all;">
                            ${exam.url}
                        </div>
                        ${exam.year ? `<div style="font-size: 0.75rem; color: #666; margin-top: 3px;">Year: ${exam.year}</div>` : ''}
                    </div>
                    <div style="margin-left: 10px;">
                        <button class="action-btn delete-btn" onclick="deleteSingleExam('${exam.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                adminExamsList.appendChild(examItem);
            });
        }

        // ============================================
        // SINGLE ITEM DELETE FUNCTIONS
        // ============================================

        async function deleteSingleBook(bookId) {
            if (confirm('Are you sure you want to delete this book?')) {
                try {
                    await deleteBookFromFirebase(bookId);
                    await loadBooksFromFirebase();
                    loadAdminBooksList();
                    updateDeleteCounts();
                    updateStats();
                } catch (error) {
                    console.error('Error deleting book:', error);
                }
            }
        }

        async function deleteSingleProject(projectId, batch) {
            if (confirm('Are you sure you want to delete this project?')) {
                try {
                    await db.collection("projects").doc(projectId).delete();
                    await loadProjectsFromFirebase();
                    loadAdminProjectsList();
                    updateDeleteCounts();
                    updateStats();
                    showNotification('Project deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting project:', error);
                    showNotification('Failed to delete project', 'error');
                }
            }
        }

        async function deleteSingleJournal(journalId) {
            if (confirm('Are you sure you want to delete this journal link?')) {
                try {
                    await db.collection("journals").doc(journalId).delete();
                    await loadJournalsFromFirebase();
                    loadAdminJournalsList();
                    updateDeleteCounts();
                    updateStats();
                    showNotification('Journal deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting journal:', error);
                    showNotification('Failed to delete journal', 'error');
                }
            }
        }

        async function deleteSingleExam(examId) {
            if (confirm('Are you sure you want to delete this exam paper?')) {
                try {
                    await db.collection("exams").doc(examId).delete();
                    await loadExamsFromFirebase();
                    loadAdminExamsList();
                    updateDeleteCounts();
                    updateStats();
                    showNotification('Exam paper deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting exam:', error);
                    showNotification('Failed to delete exam paper', 'error');
                }
            }
        }

        // Edit modal function
        function openEditModal(book) {
            document.getElementById('editBookTitle').value = book.title;
            document.getElementById('editBookAuthor').value = book.author;
            document.getElementById('editBookStatus').value = book.status;
            document.getElementById('editBookIsbn').value = book.isbn || '';
            document.getElementById('editBookYear').value = book.year || '';
            document.getElementById('editBookId').value = book.id;
            editBookModal.style.display = 'flex';
        }

        // ============================================
        // FILE UPLOAD DRAG & DROP
        // ============================================

        ['excelUpload', 'pdfUpload'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('click', () => {
                const fileInput = document.getElementById(id.replace('Upload', 'File'));
                fileInput.click();
            });
           
            el.addEventListener('dragover', (e) => {
                e.preventDefault();
                el.style.borderColor = 'var(--secondary)';
                el.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            });
           
            el.addEventListener('dragleave', () => {
                el.style.borderColor = '#ddd';
                el.style.backgroundColor = '';
            });
           
            el.addEventListener('drop', (e) => {
                e.preventDefault();
                el.style.borderColor = '#ddd';
                el.style.backgroundColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const fileInput = document.getElementById(id.replace('Upload', 'File'));
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(files[0]);
                    fileInput.files = dataTransfer.files;
                    
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            });
        });

        // ============================================
        // PDF UPLOAD HANDLER
        // ============================================

        document.getElementById('pdfFile').addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                const title = document.getElementById('projectTitle').value;
                const batchSelect = document.getElementById('projectBatch');
                const batch = batchSelect.value;
                const file = e.target.files[0];
                
                if (!title) {
                    showNotification('Please enter project title first', 'warning');
                    e.target.value = '';
                    return;
                }
                
                if (batch === 'custom') {
                    showNotification('Please select a valid batch or add one!', 'warning');
                    e.target.value = '';
                    return;
                }
                
                if (!file.type === 'application/pdf') {
                    showNotification('Please upload PDF files only', 'warning');
                    e.target.value = '';
                    return;
                }
                
                try {
                    const storageRef = storage.ref();
                    const fileRef = storageRef.child(`projects/${batch}/${Date.now()}_${file.name}`);
                    await fileRef.put(file);
                    const fileUrl = await fileRef.getDownloadURL();
                    
                    const projectData = {
                        title: title,
                        batch: batch,
                        fileUrl: fileUrl,
                        fileName: file.name,
                        addedDate: firebase.firestore.FieldValue.serverTimestamp(),
                        addedBy: auth.currentUser.email,
                        fileSize: file.size,
                        fileType: file.type,
                        isCustomBatch: customBatches.includes(batch)
                    };
                    
                    await db.collection("projects").add(projectData);
                    await loadProjectsFromFirebase();
                    loadAdminProjectsList();
                    updateDeleteCounts();
                    updateStats();
                    
                    document.getElementById('projectTitle').value = '';
                    batchSelect.value = '2026';
                    document.getElementById('customBatchSection').style.display = 'none';
                    e.target.value = '';
                    
                    showNotification('Project uploaded successfully!', 'success');
                } catch (error) {
                    console.error('Error uploading project:', error);
                    showNotification('Failed to upload project', 'error');
                }
            }
        });

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportBooksBtn.click();
            }
            
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                loadDashboardData();
            }
            
            if (e.key === 'Escape') {
                if (editBookModal.style.display === 'flex') {
                    editBookModal.style.display = 'none';
                }
                if (deleteProjectsModal.style.display === 'flex') {
                    deleteProjectsModal.style.display = 'none';
                }
                const mobileMenu = document.getElementById('mobileAdminMenu');
                if (mobileMenu && mobileMenu.classList.contains('show')) {
                    mobileMenu.classList.remove('show');
                }
            }
        });

        // ============================================
        // INITIAL LOAD
        // ============================================

        loadDashboardData();
        
        console.log('Enhanced Admin dashboard loaded successfully');
        console.log('Supports 2000+ books import');
        console.log('Two journal cards: Research Journals and Exam Papers (TNPSC)');
    </script>
</body>
</html>

