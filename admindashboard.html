<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ECE Library</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --info: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        /* Header */
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 15px 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--light);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo span {
            color: #f1c40f;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-badge i {
            color: #f1c40f;
        }

        .admin-role {
            background: var(--success);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(to right, var(--secondary), var(--primary));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(to right, var(--success), #2ecc71);
        }

        .btn-danger {
            background: linear-gradient(to right, var(--accent), #c0392b);
        }

        .btn-warning {
            background: linear-gradient(to right, #f39c12, #e67e22);
        }

        .btn-info {
            background: linear-gradient(to right, var(--info), #138496);
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.12);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            color: var(--secondary);
        }

        /* Admin Controls */
        .admin-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }

        .data-management-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .delete-section {
            border: 2px solid #ffeaea;
            border-radius: 10px;
            padding: 20px;
            background: #fff5f5;
        }

        .delete-section h3 {
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delete-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .delete-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .delete-info {
            font-size: 0.9rem;
            color: #666;
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: var(--secondary);
            background: rgba(52, 152, 219, 0.05);
        }

        .file-upload i {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }

        /* Batch Selector Grid */
        .batch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .batch-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            padding: 5px;
            background: white;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .batch-checkbox input {
            margin: 0;
        }

        .select-all-batches {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #e8f4fc;
            border-radius: 5px;
        }

        /* Add Batch Button */
        .add-batch-btn {
            background: linear-gradient(to right, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .add-batch-btn:hover {
            background: linear-gradient(to right, #229954, #27ae60);
            transform: translateY(-2px);
        }

        /* Batch Management Styles */
        .batch-management {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .batch-input-group {
            display: flex;
            gap: 5px;
            flex: 1;
        }

        .custom-batch-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        /* Custom Batch List */
        .custom-batch-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
        }

        .batch-tag {
            background: linear-gradient(to right, var(--secondary), var(--primary));
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .batch-tag:hover {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }

        .batch-tag i {
            font-size: 0.8rem;
        }

        /* Books List */
        .books-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .book-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid var(--secondary);
            position: relative;
        }

        .book-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            color: var(--dark);
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: var(--secondary);
            color: white;
        }

        .delete-btn:hover {
            background: var(--accent);
        }

        .book-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .available {
            background: #d5f4e6;
            color: var(--success);
        }

        .unavailable {
            background: #ffeaea;
            color: var(--accent);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-control:focus {
            border-color: var(--secondary);
            outline: none;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--success), #2ecc71);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Search Bar */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-container .form-control {
            flex: 1;
        }

        /* Delete All Button */
        .delete-all-btn {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .delete-all-btn:hover {
            background: linear-gradient(to right, #c0392b, #a93226);
            transform: translateY(-2px);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 15px;
            background: #f1f1f1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .page-btn.active {
            background: var(--secondary);
            color: white;
        }

        .page-btn:hover:not(.active) {
            background: #ddd;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark);
        }

        /* Notifications */
        .notifications {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 999;
            max-width: 400px;
        }

        .notification {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--accent);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification.info {
            border-left-color: var(--info);
        }

        .notification-content {
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 10px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Database Status */
        .db-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 20px;
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
        }

        .db-status.connected {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .db-status.disconnected {
            background: rgba(231, 76, 60, 0.1);
            color: var(--accent);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 25px;
            color: var(--primary);
            margin-top: 50px;
            border-top: 1px solid #ddd;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
           
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .admin-controls {
                justify-content: center;
            }
            
            .notifications {
                top: 80px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .batch-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }
            
            .batch-management {
                flex-direction: column;
            }
            
            .batch-input-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-book-open"></i>
                <h1>ECE Department <span>Library</span> - Admin Dashboard</h1>
                <span id="dbStatus" class="db-status disconnected">
                    <i class="fas fa-circle"></i> Firebase
                </span>
            </div>
            <div class="admin-info">
                <div class="admin-badge" id="adminBadge">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminEmail"></span>
                    <span class="admin-role" id="adminRole">Admin</span>
                </div>
                <button class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <button class="btn" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i> Public View
                </button>
            </div>
        </div>
    </header>

    <!-- Notifications Container -->
    <div class="notifications" id="notificationsContainer"></div>

    <!-- Edit Book Modal -->
    <div id="editBookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Edit Book</h2>
                <button class="close-modal" id="closeEditModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="editBookTitle">Book Title</label>
                <input type="text" id="editBookTitle" class="form-control">
            </div>
            <div class="form-group">
                <label for="editBookAuthor">Author</label>
                <input type="text" id="editBookAuthor" class="form-control">
            </div>
            <div class="form-group">
                <label for="editBookStatus">Availability</label>
                <select id="editBookStatus" class="form-control">
                    <option value="available">Available</option>
                    <option value="unavailable">Not Available</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editBookIsbn">ISBN (Optional)</label>
                <input type="text" id="editBookIsbn" class="form-control">
            </div>
            <div class="form-group">
                <label for="editBookYear">Year (Optional)</label>
                <input type="number" id="editBookYear" class="form-control">
            </div>
            <input type="hidden" id="editBookId">
            <button class="btn btn-success" id="saveBookChanges">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>

    <!-- Delete Projects Modal -->
    <div id="deleteProjectsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-trash"></i> Delete Projects by Batch</h2>
                <button class="close-modal" id="closeProjectsModal">&times;</button>
            </div>
            <div class="form-group">
                <label>Select Batches to Delete:</label>
                <div class="select-all-batches">
                    <input type="checkbox" id="selectAllBatches">
                    <label for="selectAllBatches">Select All Batches</label>
                </div>
                <div class="batch-grid" id="batchSelectionGrid">
                    <!-- Batches will be populated here -->
                </div>
            </div>
            <div class="form-group">
                <p id="selectedBatchesInfo">No batches selected</p>
                <p id="projectsCountInfo">0 projects will be deleted</p>
            </div>
            <button class="btn btn-danger" id="confirmDeleteProjects">
                <i class="fas fa-trash"></i> Delete Selected Batches
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <h1 style="color: var(--primary); margin-bottom: 30px;">
            <i class="fas fa-tachometer-alt"></i> Admin Dashboard
            <button class="btn btn-info" id="syncDataBtn" style="margin-left: 15px;">
                <i class="fas fa-sync-alt"></i> Sync Now
            </button>
        </h1>
       
        <div class="admin-controls">
            <button class="btn btn-success" id="addBookBtn"><i class="fas fa-plus"></i> Add Book</button>
            <button class="btn btn-success" id="addJournalBtn"><i class="fas fa-link"></i> Add Journal</button>
            <button class="btn btn-warning" id="exportBooksBtn">
                <i class="fas fa-download"></i> Export to Excel
            </button>
        </div>

        <!-- Data Management Section -->
        <div class="data-management-section">
            <div class="card">
                <h2><i class="fas fa-trash-alt"></i> Data Management</h2>
                
                <!-- Delete Books Only -->
                <div class="delete-section">
                    <h3><i class="fas fa-book"></i> Delete Books Only</h3>
                    <div class="delete-option">
                        <div>
                            <strong>Delete All Books</strong>
                            <div class="delete-info">This will delete all books from the database</div>
                        </div>
                        <button class="btn btn-danger" id="deleteBooksBtn">
                            <i class="fas fa-trash"></i> Delete <span id="booksCount">0</span> Books
                        </button>
                    </div>
                </div>

                <!-- Delete Journals Only -->
                <div class="delete-section">
                    <h3><i class="fas fa-newspaper"></i> Delete Journals Only</h3>
                    <div class="delete-option">
                        <div>
                            <strong>Delete All Journal Links</strong>
                            <div class="delete-info">This will delete all journal links from the database</div>
                        </div>
                        <button class="btn btn-danger" id="deleteJournalsBtn">
                            <i class="fas fa-trash"></i> Delete <span id="journalsCount">0</span> Journals
                        </button>
                    </div>
                </div>

                <!-- Delete Projects Only -->
                <div class="delete-section">
                    <h3><i class="fas fa-project-diagram"></i> Delete Projects Only</h3>
                    <div class="delete-option">
                        <div>
                            <strong>Delete Projects by Batch</strong>
                            <div class="delete-info">Select specific batches to delete projects</div>
                        </div>
                        <button class="btn btn-danger" id="deleteProjectsByBatchBtn">
                            <i class="fas fa-trash"></i> Delete Selected Projects
                        </button>
                    </div>
                </div>

                <!-- Clear ALL Data -->
                <div class="delete-section" style="border-color: var(--accent); background: #ffeded;">
                    <h3><i class="fas fa-exclamation-triangle"></i> Clear ALL Data</h3>
                    <div class="delete-option">
                        <div>
                            <strong>Delete EVERYTHING</strong>
                            <div class="delete-info" style="color: var(--accent); font-weight: bold;">
                                ‚ö†Ô∏è This will delete ALL books, journals, projects, and messages!
                            </div>
                        </div>
                        <button class="btn btn-danger" id="clearAllDataBtn" style="background: linear-gradient(to right, #c0392b, #a93226);">
                            <i class="fas fa-bomb"></i> Nuke Everything
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <!-- Excel Upload -->
            <div class="card">
                <h2><i class="fas fa-file-excel"></i> Excel File Upload</h2>
                <p>Upload Excel file with book data (.xlsx, .csv, .xls)</p>
                
                <!-- Progress Bar -->
                <div class="progress-container" id="uploadProgress">
                    <div class="progress-bar" id="uploadProgressBar">0%</div>
                </div>
                
                <!-- File Upload Area -->
                <div class="file-upload" id="excelUpload">
                    <i class="fas fa-file-excel"></i>
                    <p>Drag & drop Excel file here or click to browse</p>
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" hidden>
                </div>
                
                <!-- Import Options -->
                <div class="form-group" style="margin-top: 15px;">
                    <label>Import Mode:</label>
                    <select id="importMode" class="form-control">
                        <option value="append">Append to existing books</option>
                        <option value="replace">Replace all books</option>
                    </select>
                </div>
                
                <!-- Excel Template Info -->
                <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                    <p><strong>Excel Template Format:</strong></p>
                    <p>‚Ä¢ Column A: <strong>Title</strong> (Required) - Book title</p>
                    <p>‚Ä¢ Column B: <strong>Author</strong> (Required) - Author name</p>
                    <p>‚Ä¢ Column C: <strong>Status</strong> - "available" or "unavailable"</p>
                    <p>‚Ä¢ Column D: <strong>ISBN</strong> (Optional) - ISBN number</p>
                    <p>‚Ä¢ Column E: <strong>Year</strong> (Optional) - Publication year</p>
                </div>
                
                <!-- Upload Button -->
                <button class="btn" style="margin-top: 15px; width: 100%;" onclick="document.getElementById('excelFile').click()">
                    <i class="fas fa-upload"></i> Upload Excel File
                </button>
                
                <!-- Download Sample Button -->
                <button class="btn btn-info" id="downloadSampleBtn" style="margin-top: 10px; width: 100%;">
                    <i class="fas fa-download"></i> Download Sample Excel
                </button>
            </div>

            <!-- Book Management -->
            <div class="card">
                <h2><i class="fas fa-book"></i> Add/Edit Book</h2>
                <div class="form-group">
                    <label>Book Title</label>
                    <input type="text" id="bookTitle" class="form-control" placeholder="Enter book title">
                </div>
                <div class="form-group">
                    <label>Author</label>
                    <input type="text" id="bookAuthor" class="form-control" placeholder="Enter author name">
                </div>
                <div class="form-group">
                    <label>Availability</label>
                    <select id="bookStatus" class="form-control">
                        <option value="available">Available</option>
                        <option value="unavailable">Not Available</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ISBN (Optional)</label>
                    <input type="text" id="bookIsbn" class="form-control" placeholder="Enter ISBN">
                </div>
                <div class="form-group">
                    <label>Year (Optional)</label>
                    <input type="number" id="bookYear" class="form-control" placeholder="Enter publication year" min="1800" max="2026">
                </div>
                <button class="btn" id="updateBookBtn"><i class="fas fa-save"></i> Save Book</button>
            </div>

            <!-- Book List for Admin -->
            <div class="card">
                <h2><i class="fas fa-list"></i> All Books (Editable)</h2>
                <div class="search-container">
                    <input type="text" id="adminBookSearch" class="form-control" placeholder="Search books by title, author, or ISBN...">
                    <button class="btn" id="adminBookSearchBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                    <div id="adminBooksList">
                        <!-- Admin book list will be populated here -->
                    </div>
                </div>
                <div class="pagination" id="adminBooksPagination">
                    <!-- Pagination will be added by JavaScript -->
                </div>
            </div>

            <!-- Project Management -->
            <div class="card">
                <h2><i class="fas fa-file-pdf"></i> Project Management</h2>
                <div class="form-group">
                    <label>Project Title</label>
                    <input type="text" id="projectTitle" class="form-control" placeholder="Enter project title">
                </div>
                
                <!-- Batch Management -->
                <div class="form-group">
                    <label>Select Batch</label>
                    <select id="projectBatch" class="form-control">
                        <option value="2026">2026 Batch</option>
                        <option value="2025">2025 Batch</option>
                        <option value="2024">2024 Batch</option>
                        <option value="2023">2023 Batch</option>
                        <option value="2022">2022 Batch</option>
                        <option value="2021">2021 Batch</option>
                        <option value="2020">2020 Batch</option>
                        <option value="2019">2019 Batch</option>
                        <option value="2018">2018 Batch</option>
                        <option value="custom">Add Custom Batch</option>
                    </select>
                </div>
                
                <!-- Custom Batch Input -->
                <div class="batch-management" id="customBatchSection" style="display: none;">
                    <div class="batch-input-group">
                        <input type="text" id="customBatchInput" class="custom-batch-input" placeholder="Enter batch year (e.g., 2050, 2100)">
                        <button class="btn btn-success" id="addCustomBatchBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <!-- Custom Batch List -->
                <div class="custom-batch-list" id="customBatchList">
                    <!-- Custom batches will appear here -->
                </div>
                
                <div class="file-upload" id="pdfUpload">
                    <i class="fas fa-file-pdf"></i>
                    <p>Upload Project PDF file</p>
                    <input type="file" id="pdfFile" accept=".pdf" hidden>
                </div>
                <button class="btn" style="margin-top: 15px; width: 100%;" onclick="document.getElementById('pdfFile').click()">
                    <i class="fas fa-upload"></i> Upload Project PDF
                </button>
                
                <!-- Project List -->
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">Current Projects</h3>
                    <div id="adminProjectsList" style="max-height: 200px; overflow-y: auto;">
                        <!-- Admin project list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Journal Links Management -->
            <div class="card">
                <h2><i class="fas fa-link"></i> Journal Links Management</h2>
                <div class="form-group">
                    <label>Journal Name</label>
                    <input type="text" id="journalName" class="form-control" placeholder="Enter journal name">
                </div>
                <div class="form-group">
                    <label>Journal URL</label>
                    <input type="url" id="journalUrl" class="form-control" placeholder="https://example.com/journal">
                </div>
                <button class="btn" id="addJournalLinkBtn"><i class="fas fa-plus-circle"></i> Add Journal Link</button>
                
                <!-- Journal List -->
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">Current Journals</h3>
                    <div id="adminJournalsList" style="max-height: 200px; overflow-y: auto;">
                        <!-- Admin journal list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Scrolling Message Control -->
            <div class="card">
                <h2><i class="fas fa-bullhorn"></i> Scrolling Message</h2>
                <div class="form-group">
                    <label>Update Scrolling Message</label>
                    <textarea id="newMessage" class="form-control" rows="3" placeholder="Enter new scrolling message...">üìö Library Timings: 9 AM to 8 PM (Monday to Saturday) | üìñ New Arrivals: "Data Structures" & "Machine Learning Basics"</textarea>
                </div>
                <button class="btn" id="updateMessageBtn"><i class="fas fa-sync-alt"></i> Update Message</button>
            </div>
        </div>
    </div>

    <footer>
        <p>¬© 2026 Department Library Management System | Electronics And Communication Engineering Department</p>
        <p><i class="fas fa-envelope"></i> ecelibrary@department.edu | <i class="fas fa-envelope"></i>hod.ece@shanmugha.edu</p>
    </footer>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================

        const firebaseConfig = {
            apiKey: "AIzaSyAh99Zr_V2f7l_48U_5gYoNXgE9vodonsE",
            authDomain: "ece-library-d2948.firebaseapp.com",
            projectId: "ece-library-d2948",
            storageBucket: "ece-library-d2948.firebasestorage.app",
            messagingSenderId: "522135866665",
            appId: "1:522135866665:web:8fdde8c1c6611115f97b38"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ============================================
        // SESSION CHECK - MUST BE LOGGED IN
        // ============================================

        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'adminlogin.html';
                return;
            }

            const authorizedEmails = [
                "vinoth.ece@shanmugha.edu.in",
                "hod.ece@shanmugha.edu.in",
                "santhoshwebworker@gmail.com"
            ];

            if (!authorizedEmails.includes(user.email)) {
                await auth.signOut();
                localStorage.clear();
                window.location.href = 'adminlogin.html';
                return;
            }

            displayUserInfo(user);
            loadDashboardData();
        });

        function displayUserInfo(user) {
            document.getElementById('adminEmail').textContent = user.email;
            
            let role = 'Admin';
            if (user.email === 'hod.ece@shanmugha.edu.in') {
                role = 'HOD';
            } else if (user.email === 'santhoshwebworker@gmail.com') {
                role = 'Web Admin';
            }
            
            document.getElementById('adminRole').textContent = role;
        }

        // ============================================
        // NOTIFICATION SYSTEM
        // ============================================

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationsContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <strong>${type.toUpperCase()}:</strong> ${message}
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            container.appendChild(notification);
            
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            });
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // ============================================
        // GLOBAL DATA VARIABLES
        // ============================================

        let books = [];
        let projects = {};
        let journals = [];
        let adminCurrentPage = 1;
        let adminBooksPerPage = 20;
        let adminSearchQuery = '';
        let customBatches = [];

        // ============================================
        // CUSTOM BATCH MANAGEMENT
        // ============================================

        // Load custom batches from localStorage
        function loadCustomBatches() {
            const savedBatches = localStorage.getItem('customBatches');
            if (savedBatches) {
                customBatches = JSON.parse(savedBatches);
            }
            renderCustomBatches();
        }

        // Save custom batches to localStorage
        function saveCustomBatches() {
            localStorage.setItem('customBatches', JSON.stringify(customBatches));
        }

        // Render custom batches in the UI
        function renderCustomBatches() {
            const customBatchList = document.getElementById('customBatchList');
            const projectBatchSelect = document.getElementById('projectBatch');
            
            // Clear existing custom batches from select
            Array.from(projectBatchSelect.options).forEach(option => {
                if (option.value === 'custom') {
                    // Keep only the "Add Custom Batch" option
                }
            });
            
            // Add custom batches to select dropdown
            customBatches.forEach(batch => {
                const optionExists = Array.from(projectBatchSelect.options).some(
                    opt => opt.value === batch
                );
                if (!optionExists && batch !== 'custom') {
                    const option = document.createElement('option');
                    option.value = batch;
                    option.textContent = `${batch} Batch`;
                    // Insert before the "custom" option
                    const customOption = projectBatchSelect.querySelector('option[value="custom"]');
                    projectBatchSelect.insertBefore(option, customOption);
                }
            });
            
            // Render batch tags
            customBatchList.innerHTML = '';
            customBatches.forEach(batch => {
                if (batch !== 'custom') {
                    const batchTag = document.createElement('div');
                    batchTag.className = 'batch-tag';
                    batchTag.innerHTML = `
                        ${batch}
                        <i class="fas fa-times" onclick="removeCustomBatch('${batch}')"></i>
                    `;
                    customBatchList.appendChild(batchTag);
                }
            });
        }

        // Add custom batch
        function addCustomBatch() {
            const customBatchInput = document.getElementById('customBatchInput');
            const batchValue = customBatchInput.value.trim();
            
            if (!batchValue) {
                showNotification('Please enter a batch year!', 'warning');
                return;
            }
            
            // Validate batch format (should be a year)
            if (!/^\d{4}$/.test(batchValue)) {
                showNotification('Please enter a valid 4-digit year (e.g., 2050)!', 'warning');
                return;
            }
            
            const year = parseInt(batchValue);
            if (year < 1900 || year > 2200) {
                showNotification('Please enter a year between 1900 and 2200!', 'warning');
                return;
            }
            
            // Check if batch already exists
            if (customBatches.includes(batchValue)) {
                showNotification(`Batch ${batchValue} already exists!`, 'warning');
                return;
            }
            
            // Add to custom batches
            customBatches.push(batchValue);
            saveCustomBatches();
            renderCustomBatches();
            
            // Select the newly added batch
            document.getElementById('projectBatch').value = batchValue;
            customBatchInput.value = '';
            document.getElementById('customBatchSection').style.display = 'none';
            
            showNotification(`Batch ${batchValue} added successfully!`, 'success');
        }

        // Remove custom batch
        function removeCustomBatch(batch) {
            if (confirm(`Remove batch ${batch}? This won't delete existing projects in this batch.`)) {
                customBatches = customBatches.filter(b => b !== batch);
                saveCustomBatches();
                renderCustomBatches();
                showNotification(`Batch ${batch} removed!`, 'success');
            }
        }

        // ============================================
        // DASHBOARD DATA LOADING
        // ============================================

        async function loadDashboardData() {
            try {
                showNotification('Loading dashboard data...', 'info');
                
                await Promise.all([
                    loadBooksFromFirebase(),
                    loadProjectsFromFirebase(),
                    loadJournalsFromFirebase(),
                    loadScrollingMessage()
                ]);
                
                updateDbStatus(true);
                loadAdminBooksList();
                loadAdminProjectsList();
                loadAdminJournalsList();
                updateDeleteCounts();
                
                showNotification('Dashboard data loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                updateDbStatus(false);
                showNotification('Failed to load data from Firebase', 'error');
            }
        }

        function updateDbStatus(connected) {
            const statusEl = document.getElementById('dbStatus');
            if (connected) {
                statusEl.className = 'db-status connected';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Firebase Connected';
            } else {
                statusEl.className = 'db-status disconnected';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Firebase Disconnected';
            }
        }

        // Update delete button counts
        function updateDeleteCounts() {
            document.getElementById('booksCount').textContent = books.length;
            document.getElementById('journalsCount').textContent = journals.length;
        }

        // ============================================
        // FIREBASE DATA FUNCTIONS
        // ============================================

        async function loadBooksFromFirebase() {
            try {
                const querySnapshot = await db.collection("books")
                    .orderBy("addedDate", "desc")
                    .get();
                
                books = [];
                querySnapshot.forEach(doc => {
                    books.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error("Error loading books:", error);
                throw error;
            }
        }

        async function loadProjectsFromFirebase() {
            try {
                const querySnapshot = await db.collection("projects").get();
                projects = {};
                querySnapshot.forEach(doc => {
                    const project = doc.data();
                    const batch = project.batch || "2026";
                    if (!projects[batch]) projects[batch] = [];
                    projects[batch].push({ id: doc.id, ...project });
                });
                
                // Add custom batches from projects to our list
                querySnapshot.forEach(doc => {
                    const project = doc.data();
                    if (project.batch && !customBatches.includes(project.batch)) {
                        // Check if it's a custom batch (not in default list)
                        const defaultBatches = ['2026', '2025', '2024', '2023', '2022', '2021', '2020', '2019', '2018'];
                        if (!defaultBatches.includes(project.batch) && /^\d{4}$/.test(project.batch)) {
                            customBatches.push(project.batch);
                        }
                    }
                });
                
                // Remove duplicates and save
                customBatches = [...new Set(customBatches)];
                saveCustomBatches();
                renderCustomBatches();
                
            } catch (error) {
                console.error("Error loading projects:", error);
                throw error;
            }
        }

        async function loadJournalsFromFirebase() {
            try {
                const querySnapshot = await db.collection("journals")
                    .orderBy("name")
                    .get();
                
                journals = [];
                querySnapshot.forEach(doc => {
                    journals.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error("Error loading journals:", error);
                throw error;
            }
        }

        async function loadScrollingMessage() {
            try {
                const doc = await db.collection("settings").doc("scrolling_message").get();
                if (doc.exists && doc.data().message) {
                    document.getElementById('newMessage').value = doc.data().message;
                }
            } catch (error) {
                console.error("Error loading scrolling message:", error);
            }
        }

        // ============================================
        // BOOK MANAGEMENT FUNCTIONS
        // ============================================

        async function addBookToFirebase(bookData) {
            try {
                const bookWithMetadata = {
                    ...bookData,
                    addedDate: firebase.firestore.FieldValue.serverTimestamp(),
                    addedBy: auth.currentUser.email,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection("books").add(bookWithMetadata);
                showNotification(`Book "${bookData.title}" added successfully!`, 'success');
                return docRef.id;
            } catch (error) {
                console.error("Error adding book:", error);
                showNotification(`Failed to add book: ${error.message}`, 'error');
                throw error;
            }
        }

        async function updateBookInFirebase(bookId, bookData) {
            try {
                const updateData = {
                    ...bookData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: auth.currentUser.email
                };
                
                await db.collection("books").doc(bookId).update(updateData);
                showNotification(`Book "${bookData.title}" updated successfully!`, 'success');
            } catch (error) {
                console.error("Error updating book:", error);
                showNotification(`Failed to update book: ${error.message}`, 'error');
                throw error;
            }
        }

        async function deleteBookFromFirebase(bookId) {
            try {
                await db.collection("books").doc(bookId).delete();
                showNotification('Book deleted successfully!', 'success');
            } catch (error) {
                console.error("Error deleting book:", error);
                showNotification(`Failed to delete book: ${error.message}`, 'error');
                throw error;
            }
        }

        // ============================================
        // EXCEL UPLOAD FUNCTIONALITY
        // ============================================

        // Excel file upload handler
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const uploadProgress = document.getElementById('uploadProgress');
            const uploadProgressBar = document.getElementById('uploadProgressBar');
            
            uploadProgress.style.display = 'block';
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.textContent = '0%';

            const importMode = document.getElementById('importMode').value;
            const reader = new FileReader();

            reader.onload = async function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    
                    let added = 0;
                    let errors = 0;

                    // Validate required columns
                    if (rows.length === 0) {
                        showNotification('‚ùå Excel file is empty!', 'error');
                        uploadProgress.style.display = 'none';
                        return;
                    }

                    const firstRow = rows[0];
                    const hasTitle = firstRow.Title || firstRow.title || firstRow['Book Title'] || firstRow['Book Title'];
                    if (!hasTitle) {
                        showNotification('‚ùå Excel file must have "Title" column!', 'error');
                        uploadProgress.style.display = 'none';
                        return;
                    }

                    // Clear existing books if replace mode
                    if (importMode === 'replace') {
                        try {
                            showNotification('Clearing existing books...', 'info');
                            const batch = db.batch();
                            const booksSnapshot = await db.collection("books").get();
                            booksSnapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                            books = [];
                        } catch (error) {
                            console.error('Error clearing books:', error);
                        }
                    }

                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        const progress = Math.round((i / rows.length) * 100);
                        uploadProgressBar.style.width = `${progress}%`;
                        uploadProgressBar.textContent = `${progress}%`;

                        // Extract data with multiple possible column names
                        const title = String(
                            row.Title || 
                            row.title || 
                            row['Book Title'] || 
                            row['Book Title'] || 
                            ''
                        ).trim();
                        
                        const author = String(
                            row.Author || 
                            row.author || 
                            row['Author Name'] || 
                            row['Author'] || 
                            'Unknown'
                        ).trim();
                        
                        if (!title) {
                            errors++;
                            continue;
                        }

                        let status = String(
                            row.Status || 
                            row.status || 
                            row.Availability || 
                            row.availability ||
                            "available"
                        ).toLowerCase().trim();
                        
                        if (!['available', 'unavailable'].includes(status)) {
                            status = 'available';
                        }
                        
                        const isbn = String(
                            row.ISBN || 
                            row.isbn || 
                            row['ISBN Number'] || 
                            row['ISBN'] ||
                            ""
                        ).trim();
                        
                        let year = row.Year || row.year || row.Year || new Date().getFullYear();
                        if (typeof year === 'string') {
                            year = parseInt(year) || new Date().getFullYear();
                        }

                        const bookData = {
                            title: title,
                            author: author,
                            status: status,
                            isbn: isbn,
                            year: year,
                            addedDate: firebase.firestore.FieldValue.serverTimestamp(),
                            addedBy: auth.currentUser.email,
                            importedFromExcel: true,
                            importDate: new Date().toISOString()
                        };

                        try {
                            await db.collection("books").add(bookData);
                            added++;
                        } catch (error) {
                            console.error(`Error adding book at row ${i}:`, error);
                            errors++;
                        }
                    }

                    uploadProgressBar.style.width = '100%';
                    uploadProgressBar.textContent = '100%';

                    setTimeout(async () => {
                        await loadBooksFromFirebase();
                        loadAdminBooksList();
                        updateDeleteCounts();
                        uploadProgress.style.display = 'none';

                        showNotification(`‚úÖ Excel Import Complete!\n\n` +
                              `‚Ä¢ Total rows: ${rows.length}\n` +
                              `‚Ä¢ Successfully added: ${added} books\n` +
                              `‚Ä¢ Failed: ${errors} rows\n` +
                              `‚Ä¢ Total books now: ${books.length}`, 'success');
                    }, 1000);

                } catch (error) {
                    console.error('Excel import error:', error);
                    uploadProgress.style.display = 'none';
                    showNotification(`‚ùå Error importing Excel file:\n${error.message}`, 'error');
                }
            };

            reader.onerror = function() {
                uploadProgress.style.display = 'none';
                showNotification('‚ùå Error reading the Excel file', 'error');
            };

            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });

        // Download sample Excel template
        document.getElementById('downloadSampleBtn').addEventListener('click', function() {
            try {
                const sampleData = [
                    {
                        "Title": "Digital Signal Processing",
                        "Author": "John G. Proakis",
                        "Status": "available",
                        "ISBN": "9780131873742",
                        "Year": 2007
                    },
                    {
                        "Title": "Communication Systems",
                        "Author": "Simon Haykin",
                        "Status": "available", 
                        "ISBN": "9780471697909",
                        "Year": 2009
                    },
                    {
                        "Title": "Electronic Devices and Circuit Theory",
                        "Author": "Robert L. Boylestad",
                        "Status": "unavailable",
                        "ISBN": "9780132622264",
                        "Year": 2012
                    }
                ];
                
                const ws = XLSX.utils.json_to_sheet(sampleData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Books");
                
                const wscols = [
                    { wch: 40 },
                    { wch: 30 },
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 10 }
                ];
                ws['!cols'] = wscols;
                
                XLSX.writeFile(wb, "ECE_Library_Excel_Template.xlsx");
                showNotification('‚úÖ Sample Excel template downloaded!', 'success');
            } catch (error) {
                console.error('Error downloading sample:', error);
                showNotification('‚ùå Error downloading sample template', 'error');
            }
        });

        // ============================================
        // SEPARATE DELETE FUNCTIONS
        // ============================================

        // 1. DELETE BOOKS ONLY
        async function deleteBooksOnly() {
            if (books.length === 0) {
                showNotification('No books to delete!', 'warning');
                return;
            }
            
            const confirmation = prompt(`‚ö†Ô∏è DELETE ALL ${books.length} BOOKS?\n\nType "DELETE ${books.length} BOOKS" to confirm`);
            
            if (confirmation === `DELETE ${books.length} BOOKS`) {
                try {
                    showNotification(`Deleting ${books.length} books...`, 'info');
                    
                    const batch = db.batch();
                    const booksSnapshot = await db.collection("books").get();
                    booksSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    
                    await loadBooksFromFirebase();
                    loadAdminBooksList();
                    updateDeleteCounts();
                    
                    showNotification(`‚úÖ Successfully deleted ${books.length} books!`, 'success');
                } catch (error) {
                    console.error('Error deleting books:', error);
                    showNotification('‚ùå Failed to delete books', 'error');
                }
            } else {
                showNotification('Book deletion cancelled', 'info');
            }
        }

        // 2. DELETE JOURNALS ONLY
        async function deleteJournalsOnly() {
            if (journals.length === 0) {
                showNotification('No journals to delete!', 'warning');
                return;
            }
            
            const confirmation = prompt(`‚ö†Ô∏è DELETE ALL ${journals.length} JOURNAL LINKS?\n\nType "DELETE ${journals.length} JOURNALS" to confirm`);
            
            if (confirmation === `DELETE ${journals.length} JOURNALS`) {
                try {
                    showNotification(`Deleting ${journals.length} journals...`, 'info');
                    
                    const batch = db.batch();
                    const journalsSnapshot = await db.collection("journals").get();
                    journalsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    
                    await loadJournalsFromFirebase();
                    loadAdminJournalsList();
                    updateDeleteCounts();
                    
                    showNotification(`‚úÖ Successfully deleted ${journals.length} journal links!`, 'success');
                } catch (error) {
                    console.error('Error deleting journals:', error);
                    showNotification('‚ùå Failed to delete journals', 'error');
                }
            } else {
                showNotification('Journal deletion cancelled', 'info');
            }
        }

        // 3. DELETE PROJECTS BY BATCH (with checkbox selection)
        async function deleteProjectsByBatch() {
            const modal = document.getElementById('deleteProjectsModal');
            const batchGrid = document.getElementById('batchSelectionGrid');
            
            // Get all batches including custom ones
            const allBatches = Object.keys(projects).sort((a, b) => b - a);
            
            if (allBatches.length === 0) {
                showNotification('No projects to delete!', 'warning');
                return;
            }
            
            batchGrid.innerHTML = '';
            allBatches.forEach(batch => {
                const projectCount = projects[batch] ? projects[batch].length : 0;
                if (projectCount > 0) {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'batch-checkbox';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="batch-${batch}" value="${batch}" data-count="${projectCount}">
                        <label for="batch-${batch}">${batch} (${projectCount})</label>
                    `;
                    batchGrid.appendChild(checkboxDiv);
                }
            });
            
            // Add event listeners
            document.getElementById('selectAllBatches').addEventListener('change', function() {
                const checkboxes = batchGrid.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = this.checked);
                updateSelectedBatchesInfo();
            });
            
            batchGrid.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', updateSelectedBatchesInfo);
            });
            
            updateSelectedBatchesInfo();
            modal.style.display = 'flex';
        }

        // Update batch selection info
        function updateSelectedBatchesInfo() {
            const checkboxes = document.querySelectorAll('#batchSelectionGrid input[type="checkbox"]:checked');
            const selectedBatches = Array.from(checkboxes).map(cb => cb.value);
            const totalProjects = Array.from(checkboxes).reduce((sum, cb) => sum + parseInt(cb.dataset.count), 0);
            
            document.getElementById('selectedBatchesInfo').textContent = 
                `Selected: ${selectedBatches.length} batches`;
            document.getElementById('projectsCountInfo').textContent = 
                `${totalProjects} projects will be deleted`;
        }

        // 4. CLEAR ALL DATA (EVERYTHING)
        async function clearAllData() {
            const totalBooks = books.length;
            const totalJournals = journals.length;
            const totalProjects = Object.values(projects).reduce((sum, arr) => sum + arr.length, 0);
            const totalItems = totalBooks + totalJournals + totalProjects;
            
            if (totalItems === 0) {
                showNotification('No data to clear!', 'warning');
                return;
            }
            
            const confirmation = prompt(`‚ö†Ô∏è NUKE EVERYTHING?\n\n` +
                   `This will delete:\n` +
                   `‚Ä¢ ${totalBooks} books\n` +
                   `‚Ä¢ ${totalJournals} journals\n` +
                   `‚Ä¢ ${totalProjects} projects\n` +
                   `‚Ä¢ Scrolling message\n\n` +
                   `Type "NUKE ${totalItems} ITEMS" to confirm`);
            
            if (confirmation === `NUKE ${totalItems} ITEMS`) {
                try {
                    showNotification('Deleting ALL data...', 'info');
                    
                    // Delete all books
                    if (totalBooks > 0) {
                        const booksBatch = db.batch();
                        const booksSnapshot = await db.collection("books").get();
                        booksSnapshot.forEach(doc => {
                            booksBatch.delete(doc.ref);
                        });
                        await booksBatch.commit();
                    }
                    
                    // Delete all journals
                    if (totalJournals > 0) {
                        const journalsBatch = db.batch();
                        const journalsSnapshot = await db.collection("journals").get();
                        journalsSnapshot.forEach(doc => {
                            journalsBatch.delete(doc.ref);
                        });
                        await journalsBatch.commit();
                    }
                    
                    // Delete all projects
                    if (totalProjects > 0) {
                        const projectsBatch = db.batch();
                        const projectsSnapshot = await db.collection("projects").get();
                        projectsSnapshot.forEach(doc => {
                            projectsBatch.delete(doc.ref);
                        });
                        await projectsBatch.commit();
                    }
                    
                    // Clear custom batches
                    customBatches = [];
                    saveCustomBatches();
                    renderCustomBatches();
                    
                    // Clear scrolling message
                    await db.collection("settings").doc("scrolling_message").set({
                        message: "üìö DEPARTMENT OF ELECTRONICS AND COMMUNICATION ENGINEERING DIGITAL LIBRARY",
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: auth.currentUser.email
                    });
                    
                    await loadDashboardData();
                    showNotification('‚úÖ All data has been cleared successfully!', 'success');
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showNotification('‚ùå Error clearing data', 'error');
                }
            } else {
                showNotification('Data clearance cancelled', 'info');
            }
        }

        // ============================================
        // DOM ELEMENTS & EVENT LISTENERS
        // ============================================

        const logoutBtn = document.getElementById('logoutBtn');
        const syncDataBtn = document.getElementById('syncDataBtn');
        const deleteBooksBtn = document.getElementById('deleteBooksBtn');
        const deleteJournalsBtn = document.getElementById('deleteJournalsBtn');
        const deleteProjectsByBatchBtn = document.getElementById('deleteProjectsByBatchBtn');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');
        const confirmDeleteProjects = document.getElementById('confirmDeleteProjects');
        const closeProjectsModal = document.getElementById('closeProjectsModal');
        const deleteProjectsModal = document.getElementById('deleteProjectsModal');

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                localStorage.clear();
                window.location.href = 'adminlogin.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Sync data
        syncDataBtn.addEventListener('click', loadDashboardData);

        // Delete books only
        deleteBooksBtn.addEventListener('click', deleteBooksOnly);

        // Delete journals only
        deleteJournalsBtn.addEventListener('click', deleteJournalsOnly);

        // Delete projects by batch
        deleteProjectsByBatchBtn.addEventListener('click', deleteProjectsByBatch);

        // Clear all data
        clearAllDataBtn.addEventListener('click', clearAllData);

        // Confirm delete selected projects
        confirmDeleteProjects.addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('#batchSelectionGrid input[type="checkbox"]:checked');
            const selectedBatches = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedBatches.length === 0) {
                showNotification('Please select at least one batch!', 'warning');
                return;
            }
            
            let totalProjects = 0;
            selectedBatches.forEach(batch => {
                totalProjects += projects[batch] ? projects[batch].length : 0;
            });
            
            const confirmation = prompt(`‚ö†Ô∏è DELETE ${totalProjects} PROJECTS FROM ${selectedBatches.length} BATCHES?\n\n` +
                   `Selected batches: ${selectedBatches.join(', ')}\n\n` +
                   `Type "DELETE ${totalProjects} PROJECTS" to confirm`);
            
            if (confirmation === `DELETE ${totalProjects} PROJECTS`) {
                try {
                    showNotification(`Deleting projects from ${selectedBatches.length} batches...`, 'info');
                    
                    // Get all projects from selected batches
                    let projectsToDelete = [];
                    selectedBatches.forEach(batch => {
                        if (projects[batch]) {
                            projects[batch].forEach(project => {
                                projectsToDelete.push({ id: project.id, batch: batch });
                            });
                        }
                    });
                    
                    // Delete in batches of 500 (Firestore limit)
                    const batchSize = 500;
                    for (let i = 0; i < projectsToDelete.length; i += batchSize) {
                        const batch = db.batch();
                        const chunk = projectsToDelete.slice(i, i + batchSize);
                        
                        chunk.forEach(project => {
                            const docRef = db.collection("projects").doc(project.id);
                            batch.delete(docRef);
                        });
                        
                        await batch.commit();
                    }
                    
                    deleteProjectsModal.style.display = 'none';
                    await loadProjectsFromFirebase();
                    loadAdminProjectsList();
                    updateDeleteCounts();
                    
                    showNotification(`‚úÖ Successfully deleted ${totalProjects} projects from ${selectedBatches.length} batches!`, 'success');
                } catch (error) {
                    console.error('Error deleting projects:', error);
                    showNotification('‚ùå Failed to delete projects', 'error');
                }
            } else {
                showNotification('Project deletion cancelled', 'info');
            }
        });

        // Close projects modal
        closeProjectsModal.addEventListener('click', () => {
            deleteProjectsModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === deleteProjectsModal) {
                deleteProjectsModal.style.display = 'none';
            }
        });

        // ============================================
        // BOOK MANAGEMENT EVENT LISTENERS
        // ============================================

        const addBookBtn = document.getElementById('addBookBtn');
        const updateBookBtn = document.getElementById('updateBookBtn');
        const addJournalLinkBtn = document.getElementById('addJournalLinkBtn');
        const exportBooksBtn = document.getElementById('exportBooksBtn');
        const editBookModal = document.getElementById('editBookModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const saveBookChanges = document.getElementById('saveBookChanges');
        const adminBookSearch = document.getElementById('adminBookSearch');
        const adminBookSearchBtn = document.getElementById('adminBookSearchBtn');
        const updateMessageBtn = document.getElementById('updateMessageBtn');

        // Add book (simple prompt version)
        addBookBtn.addEventListener('click', () => {
            const title = prompt("Enter book title:");
            const author = prompt("Enter author name:");
           
            if (title && author) {
                const newBook = {
                    title: title,
                    author: author,
                    status: 'available',
                    isbn: '',
                    year: new Date().getFullYear()
                };
                
                addBookToFirebase(newBook).then(() => {
                    loadBooksFromFirebase().then(() => {
                        loadAdminBooksList();
                        updateDeleteCounts();
                    });
                });
            }
        });

        // Update book from form
        updateBookBtn.addEventListener('click', async () => {
            const title = document.getElementById('bookTitle').value;
            const author = document.getElementById('bookAuthor').value;
            const status = document.getElementById('bookStatus').value;
            const isbn = document.getElementById('bookIsbn').value;
            const year = document.getElementById('bookYear').value;
           
            if (!title || !author) {
                showNotification('Please enter book title and author!', 'warning');
                return;
            }
            
            const bookData = {
                title: title.trim(),
                author: author.trim(),
                status: status,
                isbn: isbn.trim(),
                year: year ? parseInt(year) : new Date().getFullYear()
            };
            
            try {
                await addBookToFirebase(bookData);
                await loadBooksFromFirebase();
                loadAdminBooksList();
                updateDeleteCounts();
                
                // Clear form
                document.getElementById('bookTitle').value = '';
                document.getElementById('bookAuthor').value = '';
                document.getElementById('bookIsbn').value = '';
                document.getElementById('bookYear').value = '';
            } catch (error) {
                console.error('Error adding book:', error);
            }
        });

        // Edit book modal
        closeEditModal.addEventListener('click', () => {
            editBookModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === editBookModal) {
                editBookModal.style.display = 'none';
            }
        });

        saveBookChanges.addEventListener('click', async () => {
            const title = document.getElementById('editBookTitle').value;
            const author = document.getElementById('editBookAuthor').value;
            const status = document.getElementById('editBookStatus').value;
            const isbn = document.getElementById('editBookIsbn').value;
            const year = document.getElementById('editBookYear').value;
            const bookId = document.getElementById('editBookId').value;
           
            if (title && author && bookId) {
                const bookData = {
                    title: title,
                    author: author,
                    status: status,
                    isbn: isbn,
                    year: year ? parseInt(year) : undefined
                };
                
                try {
                    await updateBookInFirebase(bookId, bookData);
                    await loadBooksFromFirebase();
                    loadAdminBooksList();
                    editBookModal.style.display = 'none';
                } catch (error) {
                    console.error('Error updating book:', error);
                }
            }
        });

        // Add journal link
        addJournalLinkBtn.addEventListener('click', async () => {
            const name = document.getElementById('journalName').value;
            const url = document.getElementById('journalUrl').value;
           
            if (name && url) {
                try {
                    const journalData = {
                        name: name,
                        url: url,
                        addedDate: firebase.firestore.FieldValue.serverTimestamp(),
                        addedBy: auth.currentUser.email
                    };
                    
                    await db.collection("journals").add(journalData);
                    await loadJournalsFromFirebase();
                    loadAdminJournalsList();
                    updateDeleteCounts();
                    
                    document.getElementById('journalName').value = '';
                    document.getElementById('journalUrl').value = '';
                } catch (error) {
                    console.error('Error adding journal:', error);
                }
            }
        });

        // Export books to Excel
        exportBooksBtn.addEventListener('click', () => {
            if (books.length === 0) {
                showNotification('No books to export!', 'warning');
                return;
            }
            
            try {
                const exportData = books.map(book => ({
                    'Title': book.title,
                    'Author': book.author,
                    'Status': book.status,
                    'ISBN': book.isbn || '',
                    'Year': book.year || ''
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Books");
                
                const date = new Date();
                const filename = `ECE_Library_Books_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                showNotification(`‚úÖ Exported ${books.length} books to Excel`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('‚ùå Error exporting books', 'error');
            }
        });

        // Update scrolling message
        updateMessageBtn.addEventListener('click', async () => {
            const newMessage = document.getElementById('newMessage').value;
            if (newMessage) {
                try {
                    await db.collection("settings").doc("scrolling_message").set({
                        message: newMessage,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: auth.currentUser.email
                    });
                    showNotification('Scrolling message updated successfully!', 'success');
                } catch (error) {
                    console.error('Error updating message:', error);
                    showNotification('Failed to update message', 'error');
                }
            }
        });

        // ============================================
        // SEARCH FUNCTIONALITY
        // ============================================

        adminBookSearchBtn.addEventListener('click', () => {
            adminSearchQuery = adminBookSearch.value.toLowerCase().trim();
            adminCurrentPage = 1;
            loadAdminBooksList();
        });

        adminBookSearch.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                adminSearchQuery = adminBookSearch.value.toLowerCase().trim();
                adminCurrentPage = 1;
                loadAdminBooksList();
            }
        });

        // ============================================
        // LOAD UI FUNCTIONS
        // ============================================

        function loadAdminBooksList(page = 1) {
            adminCurrentPage = page;
            const adminBooksList = document.getElementById('adminBooksList');
            adminBooksList.innerHTML = '';
           
            let filteredBooks = books;
            if (adminSearchQuery) {
                filteredBooks = books.filter(book => 
                    book.title.toLowerCase().includes(adminSearchQuery) ||
                    book.author.toLowerCase().includes(adminSearchQuery) ||
                    (book.isbn && book.isbn.toLowerCase().includes(adminSearchQuery))
                );
            }
           
            if (filteredBooks.length === 0) {
                const message = adminSearchQuery 
                    ? `No books found for "${adminSearchQuery}"`
                    : 'No books in database';
                adminBooksList.innerHTML = `<p style="text-align: center; color: #666;">${message}</p>`;
                document.getElementById('adminBooksPagination').innerHTML = '';
                return;
            }
           
            const totalPages = Math.ceil(filteredBooks.length / adminBooksPerPage);
            const startIndex = (page - 1) * adminBooksPerPage;
            const endIndex = Math.min(startIndex + adminBooksPerPage, filteredBooks.length);
            const pageBooks = filteredBooks.slice(startIndex, endIndex);
           
            pageBooks.forEach(book => {
                const bookItem = document.createElement('div');
                bookItem.className = 'book-item';
                bookItem.innerHTML = `
                    <div class="book-actions">
                        <button class="action-btn edit-btn" onclick="openEditModal(${JSON.stringify(book).replace(/"/g, '&quot;')})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteSingleBook('${book.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3>${book.title}</h3>
                    <p><strong>Author:</strong> ${book.author}</p>
                    <p><strong>Status:</strong> <span class="book-status ${book.status}">${book.status}</span></p>
                    ${book.isbn ? `<p><strong>ISBN:</strong> ${book.isbn}</p>` : ''}
                    ${book.year ? `<p><strong>Year:</strong> ${book.year}</p>` : ''}
                `;
                adminBooksList.appendChild(bookItem);
            });
            
            const pagination = document.getElementById('adminBooksPagination');
            pagination.innerHTML = '';
            
            if (totalPages > 1) {
                if (page > 1) {
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'page-btn';
                    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    prevBtn.onclick = () => loadAdminBooksList(page - 1);
                    pagination.appendChild(prevBtn);
                }
                
                const pageInfo = document.createElement('span');
                pageInfo.style.padding = '8px 15px';
                pageInfo.textContent = `Page ${page} of ${totalPages} (${filteredBooks.length} books)`;
                pagination.appendChild(pageInfo);
                
                if (page < totalPages) {
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'page-btn';
                    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    nextBtn.onclick = () => loadAdminBooksList(page + 1);
                    pagination.appendChild(nextBtn);
                }
            }
        }

        function loadAdminProjectsList() {
            const adminProjectsList = document.getElementById('adminProjectsList');
            adminProjectsList.innerHTML = '';
            
            let allProjects = [];
            
            Object.keys(projects).forEach(batch => {
                projects[batch].forEach(project => {
                    allProjects.push({
                        ...project,
                        batch: batch
                    });
                });
            });
            
            if (allProjects.length === 0) {
                adminProjectsList.innerHTML = '<p style="text-align: center; color: #666;">No projects available</p>';
                return;
            }
            
            allProjects.forEach(project => {
                const projectItem = document.createElement('div');
                projectItem.style.padding = '10px';
                projectItem.style.borderBottom = '1px solid #eee';
                projectItem.style.display = 'flex';
                projectItem.style.justifyContent = 'space-between';
                projectItem.style.alignItems = 'center';
                
                projectItem.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${project.title}</strong>
                        <div style="font-size: 0.85rem; color: #666;">
                            Batch: ${project.batch}
                        </div>
                    </div>
                    <div>
                        <button class="action-btn delete-btn" onclick="deleteSingleProject('${project.id}', '${project.batch}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                adminProjectsList.appendChild(projectItem);
            });
        }

        function loadAdminJournalsList() {
            const adminJournalsList = document.getElementById('adminJournalsList');
            adminJournalsList.innerHTML = '';
           
            if (journals.length === 0) {
                adminJournalsList.innerHTML = '<p style="text-align: center; color: #666;">No journal links available</p>';
                return;
            }
           
            journals.forEach(journal => {
                const journalItem = document.createElement('div');
                journalItem.style.padding = '10px';
                journalItem.style.borderBottom = '1px solid #eee';
                journalItem.style.display = 'flex';
                journalItem.style.justifyContent = 'space-between';
                journalItem.style.alignItems = 'center';
                
                journalItem.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${journal.name}</strong>
                        <div style="font-size: 0.85rem; color: #666; word-break: break-all;">
                            ${journal.url}
                        </div>
                    </div>
                    <div>
                        <button class="action-btn delete-btn" onclick="deleteSingleJournal('${journal.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                adminJournalsList.appendChild(journalItem);
            });
        }

        // ============================================
        // SINGLE ITEM DELETE FUNCTIONS
        // ============================================

        async function deleteSingleBook(bookId) {
            if (confirm('Are you sure you want to delete this book?')) {
                try {
                    await deleteBookFromFirebase(bookId);
                    await loadBooksFromFirebase();
                    loadAdminBooksList();
                    updateDeleteCounts();
                } catch (error) {
                    console.error('Error deleting book:', error);
                }
            }
        }

        async function deleteSingleProject(projectId, batch) {
            if (confirm('Are you sure you want to delete this project?')) {
                try {
                    await db.collection("projects").doc(projectId).delete();
                    await loadProjectsFromFirebase();
                    loadAdminProjectsList();
                    updateDeleteCounts();
                    showNotification('Project deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting project:', error);
                    showNotification('Failed to delete project', 'error');
                }
            }
        }

        async function deleteSingleJournal(journalId) {
            if (confirm('Are you sure you want to delete this journal link?')) {
                try {
                    await db.collection("journals").doc(journalId).delete();
                    await loadJournalsFromFirebase();
                    loadAdminJournalsList();
                    updateDeleteCounts();
                    showNotification('Journal deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting journal:', error);
                    showNotification('Failed to delete journal', 'error');
                }
            }
        }

        // Edit modal function
        function openEditModal(book) {
            document.getElementById('editBookTitle').value = book.title;
            document.getElementById('editBookAuthor').value = book.author;
            document.getElementById('editBookStatus').value = book.status;
            document.getElementById('editBookIsbn').value = book.isbn || '';
            document.getElementById('editBookYear').value = book.year || '';
            document.getElementById('editBookId').value = book.id;
            editBookModal.style.display = 'flex';
        }

        // ============================================
        // FILE UPLOAD DRAG & DROP
        // ============================================

        ['excelUpload', 'pdfUpload'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('click', () => {
                const fileInput = document.getElementById(id.replace('Upload', 'File'));
                fileInput.click();
            });
           
            el.addEventListener('dragover', (e) => {
                e.preventDefault();
                el.style.borderColor = 'var(--secondary)';
                el.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            });
           
            el.addEventListener('dragleave', () => {
                el.style.borderColor = '#ddd';
                el.style.backgroundColor = '';
            });
           
            el.addEventListener('drop', (e) => {
                e.preventDefault();
                el.style.borderColor = '#ddd';
                el.style.backgroundColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const fileInput = document.getElementById(id.replace('Upload', 'File'));
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(files[0]);
                    fileInput.files = dataTransfer.files;
                    
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            });
        });

        // ============================================
        // PDF UPLOAD HANDLER WITH CUSTOM BATCH SUPPORT
        // ============================================

        document.getElementById('pdfFile').addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                const title = document.getElementById('projectTitle').value;
                const batchSelect = document.getElementById('projectBatch');
                const batch = batchSelect.value;
                const file = e.target.files[0];
                
                if (!title) {
                    showNotification('Please enter project title first', 'warning');
                    e.target.value = '';
                    return;
                }
                
                if (batch === 'custom') {
                    showNotification('Please select a valid batch or add one!', 'warning');
                    e.target.value = '';
                    return;
                }
                
                if (!file.type === 'application/pdf') {
                    showNotification('Please upload PDF files only', 'warning');
                    e.target.value = '';
                    return;
                }
                
                try {
                    // Upload PDF file
                    const storageRef = storage.ref();
                    const fileRef = storageRef.child(`projects/${batch}/${Date.now()}_${file.name}`);
                    await fileRef.put(file);
                    const fileUrl = await fileRef.getDownloadURL();
                    
                    // Add project to Firestore
                    const projectData = {
                        title: title,
                        batch: batch,
                        fileUrl: fileUrl,
                        fileName: file.name,
                        addedDate: firebase.firestore.FieldValue.serverTimestamp(),
                        addedBy: auth.currentUser.email,
                        fileSize: file.size,
                        fileType: file.type,
                        isCustomBatch: customBatches.includes(batch)
                    };
                    
                    await db.collection("projects").add(projectData);
                    await loadProjectsFromFirebase();
                    loadAdminProjectsList();
                    updateDeleteCounts();
                    
                    // Clear form
                    document.getElementById('projectTitle').value = '';
                    batchSelect.value = '2026'; // Reset to default
                    document.getElementById('customBatchSection').style.display = 'none';
                    e.target.value = '';
                    
                    showNotification('Project uploaded successfully!', 'success');
                } catch (error) {
                    console.error('Error uploading project:', error);
                    showNotification('Failed to upload project', 'error');
                }
            }
        });

        // ============================================
        // CUSTOM BATCH EVENT LISTENERS
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            // Load custom batches
            loadCustomBatches();
            
            // Show/hide custom batch input
            document.getElementById('projectBatch').addEventListener('change', function() {
                const customBatchSection = document.getElementById('customBatchSection');
                if (this.value === 'custom') {
                    customBatchSection.style.display = 'flex';
                    document.getElementById('customBatchInput').focus();
                } else {
                    customBatchSection.style.display = 'none';
                }
            });
            
            // Add custom batch button
            document.getElementById('addCustomBatchBtn').addEventListener('click', addCustomBatch);
            
            // Enter key to add custom batch
            document.getElementById('customBatchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCustomBatch();
                }
            });
        });

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportBooksBtn.click();
            }
            
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                loadDashboardData();
            }
            
            if (e.key === 'Escape') {
                if (editBookModal.style.display === 'flex') {
                    editBookModal.style.display = 'none';
                }
                if (deleteProjectsModal.style.display === 'flex') {
                    deleteProjectsModal.style.display = 'none';
                }
            }
        });

        // ============================================
        // INITIAL LOAD
        // ============================================

        // Load dashboard data
        loadDashboardData();
        
        // Debug info
        console.log('Admin dashboard loaded successfully');
        console.log('XLSX library available:', typeof XLSX !== 'undefined');
    </script>
</body>
</html>
